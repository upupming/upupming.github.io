<!DOCTYPE html>
    <html>
    <head>
        <meta charset="UTF-8">
        <title>&#x4ec0;&#x4e48;&#x662f;&#x670d;&#x52a1;&#x7aef;&#x6e32;&#x67d3;</title>
        <style>
/* From extension vscode.github */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

.vscode-dark img[src$=\#gh-light-mode-only],
.vscode-light img[src$=\#gh-dark-mode-only] {
	display: none;
}

</style>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
<link href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
<style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', system-ui, 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        <style>
.task-list-item {
    list-style-type: none;
}

.task-list-item-checkbox {
    margin-left: -20px;
    vertical-align: middle;
    pointer-events: none;
}
</style>
        
    </head>
    <body class="vscode-body vscode-light">
        <hr>
<p>title: Speedy SSR åŠŸèƒ½çš„å®ç°åŸç†å’Œç»éªŒæ€»ç»“
date: 2023-05-21 17:21:17
tags:</p>
<ul>
<li>frontend
categories:</li>
<li>å‰ç«¯</li>
<li>åŸºç¡€çŸ¥è¯†</li>
</ul>
<hr>
<!--
æ˜¯ä¸ªå•¥
æœ‰å•¥ç”¨
æŠ€æœ¯éš¾ç‚¹
è¶‹åŠ¿
 -->
<p>åœ¨ 2022 å¹´ï¼Œå­—èŠ‚å®ä¹ çš„é‚£æ®µæ—¶é—´é‡Œï¼Œæˆ‘å‚ä¸äº† Speedy çš„å¼€å‘ï¼Œä¸»è¦çš„ä»»åŠ¡æ˜¯ä¸º Speedy å®ç°æœåŠ¡ç«¯æ¸²æŸ“çš„èƒ½åŠ›ï¼Œæœ¬æ–‡ä»‹ç»ä¸€ä¸‹å®ç°åŸç†ã€‚</p>
<p><img src="https://s2.loli.net/2023/05/21/h6rf7PRjOlKEZHA.png" alt="20230521221623"></p>
<!-- more -->
<h2 id="ä»€ä¹ˆæ˜¯æœåŠ¡ç«¯æ¸²æŸ“">ä»€ä¹ˆæ˜¯æœåŠ¡ç«¯æ¸²æŸ“</h2>
<p>æœåŠ¡ç«¯æ¸²æŸ“ï¼ˆServer Side Rendering, SSRï¼‰ï¼Œå°±æ˜¯æŒ‡ä»æœåŠ¡ç«¯æ¸²æŸ“å‡ºå‰ç«¯é¡µé¢çš„å†…å®¹ã€‚åœ¨ä»¥å¾€æ—©æœŸçš„æ—¶å€™ï¼Œå‰åç«¯è¿˜æ²¡æœ‰åˆ†ç¦»ï¼Œç½‘é¡µå†…å®¹å®Œå…¨æ˜¯ç”±æœåŠ¡ç«¯æ¸²æŸ“çš„ï¼Œä¾‹å¦‚ç”¨ PHP åšåç«¯ç”Ÿæˆå¥½ç½‘é¡µå†…å®¹ä¹‹åè¿”å›ç»™å‰ç«¯è´Ÿè´£æ˜¾ç¤ºï¼Œæˆ‘äº†è§£åˆ°è¿˜æœ‰ JSP (Java Server Pages), <a href="http://ASP.NET">ASP.NET</a> (Active Server Pages Network Enabled Technologies) ç­‰ã€‚ä½†æ˜¯éšç€å‰ç«¯è¶Šæ¥è¶Šå¤æ‚ï¼Œå‰åç«¯å¼€å§‹åˆ†ç¦»ï¼Œé€æ¸å‡ºç°äº†å„ç§å‰ç«¯æ¡†æ¶ï¼Œå¦‚ React (2013), Vue (2014), Angular (2016), Svelte (2016) ç­‰ç­‰ã€‚å‰åç«¯å¼€å§‹åˆ†å·¥æ˜ç¡®ï¼Œå®¢æˆ·ç«¯æ¸²æŸ“ï¼ˆClient Side Rendering, CSRï¼‰å¤§è¡Œå…¶é“ï¼Œè¿™ç§æ¨¡å¼ä¸‹é¢æ‰€æœ‰é¡µé¢å†…å®¹éƒ½ç”±å®¢æˆ·ç«¯åŠ¨æ€æ¸²æŸ“è€Œæ¥ã€‚</p>
<p>çº¯çš„å®¢æˆ·ç«¯æ¸²æŸ“ä¸»è¦æœ‰ä¸¤ä¸ªé—®é¢˜:</p>
<ol>
<li>æ‹¿åˆ°å‰ç«¯é¡µé¢ä»£ç ä¹‹åï¼Œä¸€èˆ¬é¡µé¢å¾€å¾€éœ€è¦ä»åç«¯è·å–æ•°æ®æ‰èƒ½å±•ç¤ºé¡µé¢ï¼Œå¯¼è‡´ç™½å±æ—¶é—´é•¿ã€‚</li>
<li>SSO ä¸å‹å¥½ï¼Œæœç´¢å¼•æ“æ‹¿åˆ°é¡µé¢ä¹‹åå¾€å¾€ä¸ä¼šç»§ç»­è¯·æ±‚æ•°æ®ï¼Œè¿™æ ·æŠ“å–åˆ°çš„é¡µé¢å¯èƒ½ä¼šæ˜¯åªå¸¦ JS æ–‡ä»¶çš„ç©ºç™½ HTMLã€‚</li>
</ol>
<p>è¿™æ · SSR åˆé€æ¸æµè¡Œèµ·æ¥ï¼Œä»¥å¼¥è¡¥ CSR çš„ç¼ºç‚¹ã€‚SSR ä¸»è¦çš„æ–¹æ³•æ˜¯å‰ç«¯æ¡†æ¶å®ç°ä¸€å¥—æœåŠ¡ç«¯æ¸²æŸ“çš„ APIï¼Œæ”¯æŒå¯¹ç»„ä»¶è¿›è¡Œè„±æ°´ï¼ˆhydrateï¼‰å’Œæ°´åˆï¼ˆde-hydrateï¼‰ã€‚æœåŠ¡ç«¯ï¼ˆNode.jsï¼‰è´Ÿè´£å°†å‰ç«¯ç»„ä»¶è¿›è¡Œè„±æ°´å¾—åˆ° HTML å†…å®¹ï¼Œè¿™æ ·æµè§ˆå™¨è¯·æ±‚ä¹‹åçš„é¡µé¢æ˜¯æœ‰å†…å®¹çš„ï¼Œä¸ç”¨å†é‡å¤è¯·æ±‚æ•°æ®ï¼›æµè§ˆå™¨æ‹¿åˆ°æ•°æ®å’Œ HTML ä¹‹åè¿›è¡Œæ°´åˆï¼Œç»§ç»­ä»¥å‰ç«¯ç»„ä»¶çš„å½¢å¼å®Œæˆæ¸²æŸ“ï¼Œæ”¯æŒå‰ç«¯ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸå’Œå¯¹åº”çš„ APIã€‚è¿™æ · CSR å’Œ SSR çš„ä¼˜ç‚¹å°±ç»“åˆäº†èµ·æ¥ï¼Œä½¿å¾—å¼€å‘ä½“éªŒæ›´å¥½çš„åŒæ—¶é¦–å±å¾—ä»¥ä¿è¯ï¼Œå½“ç„¶éœ€è¦ç»´æŠ¤é¢å¤–çš„ Node.js æœåŠ¡å™¨ï¼Œä»¥åŠæ„å»ºå·¥å…·éœ€è¦å¯¹æœåŠ¡ç«¯æ¸²æŸ“åšä¸€äº›æ”¯æŒï¼Œè¿™æ˜¯é¢å¤–çš„æˆæœ¬æŠ•å…¥ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘è¿™æ¬¡è¦è®²çš„å†…å®¹~</p>
<h2 id="speedy-ä¸­æœåŠ¡ç«¯æ¸²æŸ“çš„å®ç°">Speedy ä¸­æœåŠ¡ç«¯æ¸²æŸ“çš„å®ç°</h2>
<p><a href="https://github.com/upupming/speedy-ssr-examples">https://github.com/upupming/speedy-ssr-examples</a> ç»™å‡ºäº† Speedy çš„ SSR çš„ä¸€äº› DEMOã€‚ä»¥ <a href="https://github.com/upupming/speedy-ssr-examples/tree/main/examples/basic"><code>basic</code></a> é¡¹ç›®ä¸ºä¾‹ï¼Œåœ¨ <code>speedy.config.ts</code> ä¸­å®šä¹‰äº†å››ä¸ªè·¯ç”±ï¼Œåˆ†åˆ«è§£é‡Šå¦‚ä¸‹:</p>
<pre><code class="language-js">{
  <span class="hljs-comment">// ...</span>
  <span class="hljs-attr">ssr</span>: {
    <span class="hljs-attr">pages</span>: [
      <span class="hljs-comment">// SSG è·¯ç”±</span>
      {
        <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/ssg&#x27;</span>,
        <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;ssg&#x27;</span>,
      },
      <span class="hljs-comment">// SSR è·¯ç”±</span>
      {
        <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/ssr&#x27;</span>,
        <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;ssr&#x27;</span>,
      },
      <span class="hljs-comment">// æ²¡æœ‰æœåŠ¡ç«¯æ¸²æŸ“çš„çº¯é™æ€é¡µé¢</span>
      {
        <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/static&#x27;</span>,
        <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;static&#x27;</span>,
      },
      <span class="hljs-comment">// æ”¯æŒå‚æ•°çš„é¡µé¢</span>
      {
        <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/params/:id/:name&#x27;</span>,
        <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;params&#x27;</span>,
      },
    ],
  },
}

</code></pre>
<p>è¿™é‡Œ <code>name</code> å°±æ˜¯ä»£ç æ‰€å¤„çš„æ–‡ä»¶å¤¹ï¼Œ<code>path</code> æ˜¯æœ€ç»ˆäº§ç‰©çš„ URL è·¯å¾„ã€‚æ¯ä¸€ä¸ªé¡µé¢çš„ç»„ç»‡å½¢å¼éƒ½æ˜¯æ–‡ä»¶å¤¹åŒ…å«ä¸¤ä¸ªæ–‡ä»¶ <code>index.tsx</code> å’Œ <code>prefetch.ts</code> å½¢å¼ï¼Œå…¶ä¸­ <code>index.tsx</code> æ˜¯é¡µé¢ç»„ä»¶ï¼Œ<code>prefetch</code> æ˜¯æ•°æ®é¢„å–å‡½æ•°ã€‚æˆ‘ä»¬å€Ÿé‰´äº† Next.js çš„æ€è·¯ï¼Œæ ¹æ® <code>prefetch</code> ä¸­å¯¼å‡ºçš„å‡½æ•°åç¡®å®šå½“å‰é¡µé¢æ˜¯ SSR è¿˜æ˜¯ SSG (Server Side Generating, æœåŠ¡ç«¯ç”Ÿæˆ)ã€‚ä¸ SSR ä¸åŒï¼ŒSSG åªåœ¨æ„å»ºçš„æ—¶å€™ç”Ÿæˆä¸€æ¬¡æ•°æ®ï¼Œç„¶ååœ¨å‰ç«¯è®¿é—®æ—¶æ¯æ¬¡éƒ½è·å–æ„å»ºæ—¶çš„æ•°æ®ï¼Œè¿™ç§æ¯”è¾ƒé€‚ç”¨äºæ„å»ºæ—¶å†…å®¹å°±ç¡®å®šäº†çš„é¡µé¢ï¼Œä¾‹å¦‚ä¸ªäººåšå®¢ã€‚</p>
<p><code>prefetch</code> ä¸­çš„æ•°æ®ä¼šä½œä¸º <code>props</code> å–‚ç»™ <code>index.tsx</code> ä¸­çš„ç»„ä»¶ï¼Œç„¶åæ¸²æŸ“æˆå½“å‰é¡µé¢ï¼Œä¸»è¦ç”¨æ¥è§£å†³é¦–å±æ•°æ®è¯·æ±‚è€—æ—¶é€ æˆç™½å±çš„é—®é¢˜ï¼Œè¦æ±‚å¯¼å‡ºçš„å‡½æ•°åç§°å¿…é¡»ä¸º <code>getStaticProps</code> æˆ–è€… <code>getServerSideProps</code>ï¼Œå‰è€…æ˜¯ SSGï¼Œåè€…æ˜¯ SSRã€‚</p>
<p>ä»¥ <code>/ssr</code> é¡µé¢ä¸ºä¾‹ï¼Œåç«¯ä¼šç›´æ¥è¿”å›å¸¦å†…å®¹çš„ HTMLï¼Œå¹¶ä¸”å°† <code>prefetch</code> ä¸­é¢„å–åˆ°çš„æ•°æ®æŒ‚åœ¨å…¨å±€å˜é‡ <code>__CONTEXT__.routeData</code> ä¹‹ä¸‹ï¼Œä»¥ä¾›å‰ç«¯ç»§ç»­æ°´åˆï¼Œå°† HTML å˜æˆç»‘å®šäº†äº‹ä»¶å’Œç”Ÿå‘½å‘¨æœŸçš„ React ç»„ä»¶ã€‚</p>
<p><img src="https://s2.loli.net/2023/05/21/a4HzbSqZ1K7VoBx.png" alt="20230521194101">
<img src="https://s2.loli.net/2023/05/21/7UlhG8MIa9PzZ1T.png" alt="20230521194138"></p>
<p>æˆ‘ä»¬ä½¿ç”¨ <code>@speedy-js/universal</code> åŒ…æ¥æ”¯æŒ SSRï¼Œå…¶å°è£…äº† <code>@speedy-js/core</code>ï¼Œåœ¨å…¶åŸºç¡€ä¸Šå¢åŠ äº† SSR å’Œ SSG çš„èƒ½åŠ›ã€‚<code>@speedy-js/universal</code> çš„ä¸»è¦è´¡çŒ®æœ‰:</p>
<ul>
<li>å®ç°äº†ä¸€ä¸ª <code>BaseBundler</code> ç±»ï¼ŒåŒ…å« <code>serverBundler</code> å’Œ <code>clientBundler</code>ã€‚å®ç°äº† <code>ReactBundler</code> æ¥å®ç°å¯¹ React æ¡†æ¶ä»£ç çš„ç¼–è¯‘ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡é…ç½® <code>ssr.framework</code> æ¥é…ç½®å½“å‰ä½¿ç”¨çš„æ¡†æ¶ã€‚
<ul>
<li>åœ¨ Speedy ä¸­å­˜åœ¨å­ç¼–è¯‘å™¨çš„æ¦‚å¿µï¼Œä¹Ÿæ˜¯å€Ÿé‰´äº Webpackï¼Œæˆ‘ä»¬é€šè¿‡å°† <code>serverBundler</code> ä½œä¸º <code>clientBundler</code> çš„å­ç¼–è¯‘å™¨ï¼Œè¿™æ ·åœ¨å¼€å‘æ¨¡å¼ä¸‹åªæœ‰ä¸€ä¸ª watcherï¼Œä»£ç å‘ç”Ÿä¿®æ”¹æ—¶ï¼Œ<code>clientBundler</code> ä¼šé€šçŸ¥ <code>serverBundler</code>ã€‚</li>
<li><code>serverBundler</code> è´Ÿè´£ç¼–è¯‘æœåŠ¡ç«¯ä»£ç ï¼Œäº§ç‰©æ˜¯ CJS æ ¼å¼ã€‚ç¼–è¯‘äº§ç‰©ä»£ç å­˜åœ¨ä¸¤ä¸ªå¯¼å‡ºå‡½æ•°ï¼Œåˆ†åˆ«æ˜¯ <code>Component</code> å’Œ <code>getServerSideProps</code>ï¼Œå…¶ä¸­ <code>Component</code> æ˜¯æœåŠ¡ç«¯ä»£ç çš„ React ç»„ä»¶ï¼Œ<code>getServerSideProps</code> æ˜¯å¯¹åº”çš„ <code>prefetch.ts</code> ä¸­çš„æ•°æ®é¢„å–å‡½æ•°ã€‚
<ul>
<li>è„±æ°´é€»è¾‘å·²ç»å°è£…åœ¨ bundler å†…éƒ¨ï¼Œåé¢çš„ Server ä¼šè´Ÿè´£å°† <code>Component</code> è„±æ°´å¹¶å¤„ç†å‰ç«¯è¯·æ±‚ã€‚</li>
</ul>
</li>
<li><code>clientBundler</code> è´Ÿè´£ç¼–è¯‘å®¢æˆ·ç«¯ä»£ç ï¼Œäº§ç‰©æ˜¯ SystemJS æ ¼å¼ï¼ˆåˆ©ç”¨ SystemJS æ”¯æŒåˆ†åŒ…ï¼‰ã€‚åŒæ ·åŒ…å«ä¸¤ä¸ªå¯¼å‡ºï¼Œåˆ†åˆ«æ˜¯ <code>default</code> å’Œ <code>getServerSideProps</code>ã€‚<code>default</code> æ˜¯å®¢æˆ·ç«¯ä»£ç çš„ React ç»„ä»¶ï¼Œ<code>getServerSideProps</code> æ˜¯å¯¹åº”çš„ <code>prefetch.ts</code> ä¸­çš„æ•°æ®é¢„å–å‡½æ•°ã€‚<code>getServerSideProps</code> åœ¨å®¢æˆ·ç«¯ä»£ç ä¸­ä»ç„¶å­˜åœ¨æ˜¯ä¸ºäº†è¿›è¡Œ CSR é™çº§ï¼Œåœ¨æœåŠ¡ç«¯æŒ‚æ‰æ—¶ä»ç„¶èƒ½å¤Ÿè¿›è¡Œæ•°æ®è¯·æ±‚ã€‚
<ul>
<li>åªé è¿™ä¸¤ä¸ªå¯¼å‡ºï¼Œæ— æ³•é¡µé¢æ­£å¸¸è¿è¡Œï¼Œå› æ­¤æˆ‘ä»¬çš„ Server è¿˜ä¼šå¢åŠ  JS æ–‡ä»¶ï¼Œåˆ©ç”¨è¿™ä¸¤ä¸ªå¯¼å‡ºï¼Œåœ¨å¯¹åº”çš„æ—¶æœºè¿›è¡Œæ°´åˆï¼Œä½¿é¡µé¢æ­£å¸¸å·¥ä½œã€‚</li>
</ul>
</li>
</ul>
</li>
<li>å®ç°äº†ä¸€ä¸ª <code>BaseServer</code> ç±»ï¼Œå¯ä»¥é€šè¿‡ <code>createServer</code> å‡½æ•°æ¥åˆ›å»ºå…¶å­ç±» <code>DevServer</code>ï¼ˆåŠŸèƒ½ç±»ä¼¼ <code>vite dev</code>ï¼‰ æˆ–è€… <code>ProdServer</code>ï¼ˆåŠŸèƒ½ç±»ä¼¼ <code>vite preview</code>ï¼‰,å…¶è¿”å›ç»“æœç±»ä¼¼äº <a href="https://github.com/vercel/next.js/blob/cfa8ab9cbfb8818408654e223aa9253be619879e/packages/next/server/next.ts#L25">NextServer</a>, ä½¿ç”¨ä¾‹å­å‚è€ƒ <a href="https://nextjs.org/docs/advanced-features/custom-server">Next.js | Custom Server</a>ã€‚å¹¶ä¸”ä¸ä¹‹å¯¹åº”æœ‰ä¸€ä¸ª <code>createHttpServer</code> å‡½æ•°æ¥åˆ›å»º Server çš„åŒæ—¶ç»‘å®šåˆ°ç«¯å£è®©å‰ç«¯ç›´æ¥è®¿é—®ã€‚
<ul>
<li>é‡‡ç”¨äº† Connect ä¸­é—´ä»¶å®ç°å†…éƒ¨çš„è¯·æ±‚å¤„ç†é€»è¾‘ï¼Œæ–¹ä¾¿æ‹“å±•å’Œå¤ç”¨ã€‚</li>
</ul>
</li>
<li>æ”¯æŒäº†ä¸åŒçš„ Adapterï¼Œæ¥å®ç°å°†äº§ç‰©éƒ¨ç½²åˆ°ä¸åŒçš„ Serverless ç¯å¢ƒã€‚æ”¯æŒäº† Vercel å’Œ Cloudflare Workerã€‚</li>
</ul>
<h3 id="bundler-å®ç°">Bundler å®ç°</h3>
<p><code>BaseBundler</code> åŒ…å«ä¸€äº›é€šç”¨é€»è¾‘ï¼Œå…·ä½“ä¸åŒæ¡†æ¶çš„å®ç°ç”±å¯¹åº”çš„å­ç±»å»å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥æŠ½è±¡å‡ºä¸€äº› Bundler éœ€è¦åšçš„äº‹æƒ…ï¼š</p>
<ul>
<li>åŒ…å« <code>clientBundler</code> å’Œ <code>serverBundler</code> åˆ†åˆ«ç¼–è¯‘å®¢æˆ·ç«¯ä»£ç å’ŒæœåŠ¡ç«¯ä»£ç ã€‚</li>
<li>åœ¨æ„å»ºæ—¶è¿›è¡Œ SSG ç”Ÿæˆï¼Œè°ƒç”¨å¯¹åº”è¯­è¨€çš„ <code>SSGRunner</code> æ¥ç”Ÿæˆ JSON æ•°æ®åˆ°äº§ç‰©ä¸­ã€‚</li>
</ul>
<p><code>ReactBundler</code> åŒ…å«å…·ä½“çš„å®ç°ï¼Œä¸‹é¢æ˜¯åˆå§‹åŒ– <code>clientBundler</code> å’Œ <code>serverBundler</code> çš„é€»è¾‘ï¼š</p>
<pre><code class="language-ts"><span class="hljs-variable language_">this</span>.<span class="hljs-property">clientBundler</span> = <span class="hljs-keyword">await</span> <span class="hljs-title class_">SpeedyBundler</span>.<span class="hljs-title function_">create</span>(
  {
    ...config,
    <span class="hljs-attr">target</span>: <span class="hljs-string">&#x27;es6&#x27;</span>,
    root,
    <span class="hljs-attr">mode</span>: dev ? <span class="hljs-string">&#x27;development&#x27;</span> : <span class="hljs-string">&#x27;production&#x27;</span>,
    <span class="hljs-attr">input</span>: {
      <span class="hljs-comment">// Client-side-only entries</span>
      ...config?.<span class="hljs-property">input</span>,
      <span class="hljs-comment">// SSR client entriesï¼Œæˆ‘ä»¬å¯¹æ¯ä¸ªé¡µé¢éƒ½ç”Ÿæˆäº†ä¸€ä¸ªè™šæ‹Ÿå…¥å£æ–‡ä»¶ï¼Œè¿™æ ·èƒ½å¤Ÿå¯¹ç”¨æˆ·ç¼–å†™çš„æ–‡ä»¶è¿›è¡Œ importï¼Œåœ¨ç”¨æˆ·ä»£ç çš„åŸºç¡€ä¸Šåšä¸€äº›å°è£…ï¼›virtual entry çš„æ€è·¯åœ¨æ„å»ºå·¥å…·ä¸­å¾ˆå¸¸è§</span>
      ...<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">fromEntries</span>(appContext.<span class="hljs-property">normalizedPages</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">{ name }</span>) =&gt;</span> [name, <span class="hljs-title function_">getVirtualEntry</span>(name)])),
      <span class="hljs-comment">// virtual entryï¼Œè¿™é‡Œçš„è™šæ‹Ÿå…¥å£çš„ä»£ç ä¹Ÿå°±æ˜¯é©±åŠ¨å®¢æˆ·ç«¯ä»£ç è¿›è¡Œæ°´åˆçš„é‚£éƒ¨åˆ†æ¨¡æ¿ä»£ç </span>
      <span class="hljs-comment">// VIRTUAL_ROOT_NAME === &#x27;__ROOT__&#x27;</span>
      [<span class="hljs-variable constant_">VIRTUAL_ROOT_NAME</span>]: <span class="hljs-title function_">getVirtualEntry</span>(<span class="hljs-variable constant_">VIRTUAL_ROOT_NAME</span>),
    },
    <span class="hljs-attr">output</span>: {
      <span class="hljs-attr">format</span>: <span class="hljs-string">&#x27;system&#x27;</span>,
      <span class="hljs-attr">splitting</span>: <span class="hljs-literal">true</span>,
      ...config?.<span class="hljs-property">output</span>,
      <span class="hljs-attr">path</span>: <span class="hljs-variable constant_">OUTPUT_FOLDER</span>,
      <span class="hljs-attr">entryNames</span>: dev ? <span class="hljs-string">&#x27;client/[name]&#x27;</span> : <span class="hljs-string">&#x27;client/[name]-[hash]&#x27;</span>,
      <span class="hljs-attr">chunkNames</span>: <span class="hljs-string">&#x27;client/[name].[hash]&#x27;</span>,
    },
    <span class="hljs-attr">define</span>: {
      <span class="hljs-attr">__BROWSER__</span>: <span class="hljs-string">&#x27;true&#x27;</span>,
      <span class="hljs-attr">global</span>: <span class="hljs-string">&#x27;globalThis&#x27;</span>,
    },
    <span class="hljs-attr">command</span>: dev ? <span class="hljs-string">&#x27;serve&#x27;</span> : <span class="hljs-string">&#x27;build&#x27;</span>,
    <span class="hljs-attr">watch</span>: dev,
    <span class="hljs-attr">configFile</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">platform</span>: <span class="hljs-string">&#x27;browser&#x27;</span>,
    <span class="hljs-attr">plugins</span>: [
      ...(config?.<span class="hljs-property">plugins</span> ?? []),
      <span class="hljs-title function_">resolvePlugin</span>({ root }),
      <span class="hljs-comment">// clientPlugin é‡Œé¢åŒ…å«äº†å¯¹ virtual entry çš„å¤„ç†é€»è¾‘å’Œå¯¹åº”åº”è¯¥ç”Ÿæˆçš„ä»£ç ã€‚</span>
      <span class="hljs-title function_">clientPlugin</span>({
        <span class="hljs-attr">appContext</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">appContext</span>,
      }),
      <span class="hljs-comment">// è¿›åº¦æ¡æ’ä»¶ï¼Œå¹¶è¡Œå±•ç¤º Client ä»£ç çš„è¿›åº¦æ¡</span>
      <span class="hljs-title function_">progressPlugin</span>({ <span class="hljs-attr">id</span>: <span class="hljs-string">&#x27;Client&#x27;</span>, <span class="hljs-attr">quietOnDev</span>: <span class="hljs-literal">false</span> }),
    ],
  },
  <span class="hljs-string">&#x27;universal.client&#x27;</span>
);

<span class="hljs-keyword">const</span> serverPlatform = environment === <span class="hljs-string">&#x27;node&#x27;</span> ? <span class="hljs-string">&#x27;node&#x27;</span> : <span class="hljs-string">&#x27;browser&#x27;</span>;

<span class="hljs-variable language_">this</span>.<span class="hljs-property">serverBundler</span> = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">clientBundler</span>.<span class="hljs-title function_">createChildCompiler</span>(
  {
    ...config,
    root,
    <span class="hljs-attr">input</span>: <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">fromEntries</span>(appContext.<span class="hljs-property">normalizedPages</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">{ name }</span>) =&gt;</span> [name, <span class="hljs-title function_">getVirtualEntry</span>(name)])),
    <span class="hljs-attr">output</span>: {
      <span class="hljs-attr">splitting</span>: <span class="hljs-literal">true</span>,
      ...config?.<span class="hljs-property">output</span>,
      <span class="hljs-attr">format</span>: <span class="hljs-string">&#x27;cjs&#x27;</span>,
      <span class="hljs-attr">path</span>: <span class="hljs-variable constant_">OUTPUT_FOLDER</span>,
      <span class="hljs-attr">entryNames</span>: <span class="hljs-string">&#x27;server/[name]&#x27;</span>,
      <span class="hljs-attr">chunkNames</span>: <span class="hljs-string">&#x27;server/[name].[hash]&#x27;</span>,
    },
    <span class="hljs-attr">html</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">mode</span>: dev ? <span class="hljs-string">&#x27;development&#x27;</span> : <span class="hljs-string">&#x27;production&#x27;</span>,
    <span class="hljs-attr">minify</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">command</span>: <span class="hljs-string">&#x27;build&#x27;</span>,
    <span class="hljs-attr">watch</span>: dev,
    <span class="hljs-attr">configFile</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">define</span>: {
      <span class="hljs-attr">__BROWSER__</span>: <span class="hljs-string">&#x27;false&#x27;</span>,
    },
    <span class="hljs-attr">platform</span>: serverPlatform,
    <span class="hljs-attr">plugins</span>: [
      ...(config?.<span class="hljs-property">plugins</span> ?? []),
      <span class="hljs-title function_">resolvePlugin</span>({ root, <span class="hljs-attr">external</span>: <span class="hljs-literal">true</span> }),
      <span class="hljs-title function_">externalPlugin</span>(externalOptions),
      <span class="hljs-comment">// serverPlugin é‡Œé¢åŒ…å«äº†å¯¹ virtual entry çš„å¤„ç†é€»è¾‘å’Œå¯¹åº”åº”è¯¥ç”Ÿæˆçš„ä»£ç ã€‚</span>
      <span class="hljs-title function_">serverPlugin</span>({ root, appContext }),
      <span class="hljs-comment">// è¿›åº¦æ¡æ’ä»¶ï¼Œå¹¶è¡Œå±•ç¤º Server ä»£ç çš„è¿›åº¦æ¡</span>
      <span class="hljs-title function_">progressPlugin</span>({ <span class="hljs-attr">id</span>: <span class="hljs-string">&#x27;Server&#x27;</span>, <span class="hljs-attr">quietOnDev</span>: <span class="hljs-literal">false</span> }),
    ],
  },
  <span class="hljs-string">&#x27;universal.server&#x27;</span>
);
</code></pre>
<p>è¿™é‡Œæœ€æ ¸å¿ƒçš„æ˜¯å¯¹ç”Ÿæˆäº§ç‰©çš„ä»£ç çš„æ§åˆ¶ï¼Œå…¶å®ç°é€»è¾‘åœ¨ <code>clientPlugin</code> ä¸­ã€‚Speedy ä¸­æ’ä»¶å‡æ˜¯é€šè¿‡ Tapable çš„ hook æ¥å®ç°äº†ï¼Œä¹Ÿæ˜¯å€Ÿé‰´äº† Webpack çš„æ’ä»¶ä½“ç³»ã€‚æˆ‘ä»¬æ¥çœ‹ <code>clientPlugin</code> ä¸­æ¯”è¾ƒæ ¸å¿ƒçš„ä»£ç ç”Ÿæˆé€»è¾‘ï¼š</p>
<pre><code class="language-tsx"><span class="hljs-comment">// packages/universal/src/bundler/react/plugins/virtual-entry/client.tsx</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ReactDOM</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-dom&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Browser</span>, loadRouteModules } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@speedy-js/universal/components&#x27;</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">init</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;__SPEEDY_DATA__&#x27;</span>)?.<span class="hljs-property">textContent</span> ?? <span class="hljs-string">&#x27;{}&#x27;</span>);
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">__SPEEDY__</span> = data;

  <span class="hljs-keyword">const</span> root = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;root&#x27;</span>);
  <span class="hljs-keyword">if</span> (!root) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;ğŸ”¥ Hmm, cannot find `#root` to mount the component.&#x27;</span>);
  }

  <span class="hljs-keyword">if</span> (!data.<span class="hljs-property">__SSR__</span>) {
    <span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">render</span>(<span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Browser</span> /&gt;</span></span>, root);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">const</span> { assetsMeta, matchedPage } = data.<span class="hljs-property">__CONTEXT__</span>;

    <span class="hljs-keyword">const</span> { assets, <span class="hljs-variable language_">module</span> } = assetsMeta[matchedPage.<span class="hljs-property">name</span>];
    <span class="hljs-keyword">const</span> routeModule = <span class="hljs-keyword">await</span> <span class="hljs-title function_">loadRouteModules</span>(assets, <span class="hljs-variable language_">module</span>, matchedPage.<span class="hljs-property">name</span>);
    data.<span class="hljs-property">__CONTEXT__</span>.<span class="hljs-property">routeModules</span>[matchedPage.<span class="hljs-property">name</span>] = routeModule;

    <span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">hydrate</span>(<span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Browser</span> /&gt;</span></span>, root);
  }

  <span class="hljs-variable language_">window</span>.<span class="hljs-property">__SPEEDY_APP_LOADED__</span> = <span class="hljs-literal">true</span>;
}

<span class="hljs-title function_">init</span>();

</code></pre>
<pre><code class="language-ts"><span class="hljs-keyword">import</span> clientVirtualEntryCode <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./virtual-entry/client?raw&#x27;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> clientPlugin = ({ appContext }: { <span class="hljs-attr">appContext</span>: <span class="hljs-title class_">AppContext</span> }): <span class="hljs-function"><span class="hljs-params">SpeedyPlugin</span> =&gt;</span> {
  compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">load</span>.<span class="hljs-title function_">tapPromise</span>(<span class="hljs-variable constant_">CLIENT_PLUGIN_NAME</span>, <span class="hljs-keyword">async</span> (args) =&gt; {
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(<span class="hljs-variable constant_">VIRTUAL_ENTRY_SUFFIX</span>).<span class="hljs-title function_">test</span>(args.<span class="hljs-property">path</span>)) {
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">const</span> { query } = <span class="hljs-title function_">resolvePathAndQuery</span>(args.<span class="hljs-property">path</span>);

    <span class="hljs-keyword">const</span> pageName = query[<span class="hljs-variable constant_">QUERY_PAGE_NAME</span>];

    <span class="hljs-keyword">if</span> (!pageName) {
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">if</span> (pageName === <span class="hljs-variable constant_">VIRTUAL_ROOT_NAME</span>) {
      <span class="hljs-comment">// æŠŠæ¨¡æ¿ä»£ç ä½œä¸ºå­—ç¬¦ä¸²è¿”å›ç»™ speedy è¿›è¡Œç¼–è¯‘ï¼Œå®ç°äº†å¯¹ç”¨æˆ·ä»£ç çš„å°è£…</span>
      <span class="hljs-keyword">const</span> entryHelper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">EntryHelper</span>(clientVirtualEntryCode);

      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">loader</span>: <span class="hljs-string">&#x27;tsx&#x27;</span>,
        <span class="hljs-attr">resolveDir</span>: root,
        <span class="hljs-attr">contents</span>: entryHelper.<span class="hljs-title function_">toString</span>(),
      };
    }

    <span class="hljs-keyword">const</span> page = appContext.<span class="hljs-title function_">getPageByName</span>(pageName)!;

    <span class="hljs-keyword">const</span> prefetchPath = page.<span class="hljs-property">prefetch</span>;
    <span class="hljs-keyword">const</span> relativePrefetchPath = prefetchPath &amp;&amp; path.<span class="hljs-title function_">relative</span>(root, prefetchPath);

    <span class="hljs-keyword">const</span> entryPath = page.<span class="hljs-property">entry</span>;
    <span class="hljs-keyword">const</span> relativeEntryPath = path.<span class="hljs-title function_">relative</span>(root, entryPath);
    <span class="hljs-keyword">const</span> entryHelper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">EntryHelper</span>(<span class="hljs-string">`export { default } from &#x27;./<span class="hljs-subst">${relativeEntryPath}</span>&#x27;`</span>);

    <span class="hljs-keyword">if</span> (prefetchPath &amp;&amp; fs.<span class="hljs-title function_">existsSync</span>(prefetchPath)) {
      <span class="hljs-keyword">const</span> <span class="hljs-attr">entryPoints</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt; = {
        <span class="hljs-attr">prefetch</span>: prefetchPath,
      };
      <span class="hljs-keyword">const</span> buildResult = esbuild.<span class="hljs-title function_">buildSync</span>({
        <span class="hljs-attr">absWorkingDir</span>: root,
        entryPoints,
        <span class="hljs-attr">outdir</span>: root,
        <span class="hljs-attr">metafile</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">write</span>: <span class="hljs-literal">false</span>,
      });
      <span class="hljs-keyword">const</span> prefetchExportedNames = buildResult.<span class="hljs-property">metafile</span>?.<span class="hljs-property">outputs</span>?.[<span class="hljs-string">&#x27;prefetch.js&#x27;</span>]?.<span class="hljs-property">exports</span>;

      <span class="hljs-keyword">const</span> isSSG = prefetchExportedNames?.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&#x27;getStaticProps&#x27;</span>);
      <span class="hljs-keyword">const</span> isSSR = prefetchExportedNames?.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&#x27;default&#x27;</span>);

      <span class="hljs-keyword">if</span> (isSSG) {
        prefetchTypeMap[pageName] = <span class="hljs-variable constant_">PREFETCH_TYPE</span>.<span class="hljs-property">SSG</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isSSR) {
        prefetchTypeMap[pageName] = <span class="hljs-variable constant_">PREFETCH_TYPE</span>.<span class="hljs-property">SSR</span>;

        entryHelper.<span class="hljs-title function_">addReExport</span>({
          <span class="hljs-attr">exportName</span>: <span class="hljs-string">&#x27;default as getServerSideProps&#x27;</span>,
          <span class="hljs-attr">filepath</span>: <span class="hljs-string">`./<span class="hljs-subst">${relativePrefetchPath}</span>`</span>,
        });
      }
    }

    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">loader</span>: <span class="hljs-string">&#x27;tsx&#x27;</span>,
      <span class="hljs-attr">resolveDir</span>: root,
      <span class="hljs-attr">contents</span>: entryHelper.<span class="hljs-title function_">toString</span>(),
    };
  });
}
</code></pre>
<p>ä¸‹é¢æ˜¯ <code>basic</code> ä¸ºä¾‹å­ç”Ÿæˆçš„ <code>__ROOT__.js</code> å’Œ <code>client/ssr.js</code> çš„ç®€åŒ–ç‰ˆæœ¬:</p>
<pre><code class="language-js"><span class="hljs-comment">// __ROOT__.js</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">init</span>(<span class="hljs-params"></span>) {
  <span class="hljs-comment">//...</span>
}
<span class="hljs-comment">// æ°´åˆé€»è¾‘</span>
<span class="hljs-title function_">init</span>()
</code></pre>
<pre><code class="language-js"><span class="hljs-comment">// React ç»„ä»¶</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) {}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>
<span class="hljs-comment">// æ•°æ®é¢„å–å‡½æ•°</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getServerSideProps</span>(<span class="hljs-params"></span>){}
</code></pre>
<p>å¦å¤– <code>clientPlugin</code> åœ¨åå¤„ç† HTML æ–‡ä»¶çš„æ—¶å€™ï¼Œä¼šåŠ å…¥ä¸€äº›å…ƒä¿¡æ¯ï¼ˆmanifestï¼‰ï¼Œåç»­å¯ä¾›ä½¿ç”¨ï¼š</p>
<pre><code class="language-ts">compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">processAssets</span>.<span class="hljs-title function_">tapPromise</span>(
  {
    <span class="hljs-attr">name</span>: <span class="hljs-variable constant_">CLIENT_PLUGIN_NAME</span>,
    <span class="hljs-attr">stage</span>: compiler.<span class="hljs-property">STAGE</span>.<span class="hljs-property">PROCESS_ASSETS_MODIFY_GENERATED_HTML</span>,
  },
  <span class="hljs-keyword">async</span> (bundles, manifest) =&gt; {
    <span class="hljs-comment">// ...</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [chunkName, chunk] <span class="hljs-keyword">of</span> compiler.<span class="hljs-property">outputChunk</span>.<span class="hljs-title function_">entries</span>()) {
      <span class="hljs-comment">// ...</span>
      <span class="hljs-comment">// Append root.js to all html outputs</span>
      <span class="hljs-keyword">if</span> (chunkName.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">&#x27;.html&#x27;</span>)) {
        <span class="hljs-comment">// add manifest to all pages</span>
        chunk.<span class="hljs-property">contents</span> = chunk.<span class="hljs-property">contents</span>.<span class="hljs-title function_">toString</span>().<span class="hljs-title function_">replace</span>(
          <span class="hljs-string">&#x27;&lt;/body&gt;&#x27;</span>,
          <span class="hljs-string">`
          &lt;script id=&quot;<span class="hljs-subst">${__SPEEDY_DATA_ID__}</span>&quot; type=&quot;application/json&quot;&gt;
          <span class="hljs-subst">${serializeState&lt;SpeedyData&gt;({
            __CONTEXT__: {
              basename: ssrOptions.baseUrl,
              matchedPage,
              pages: ssrOptions.pages,
              isModule,
              assetsMeta,
              routeData: {},
              routeModules: {},
              getServerDataMeta: {},
            },
            __SSR__: <span class="hljs-literal">false</span>,
          })}</span>
          &lt;/script&gt;
          &lt;/body&gt;
          `</span>.<span class="hljs-title function_">trim</span>()
      }
  }
</code></pre>
<p>å†æ¥çœ‹ <code>serverPlugin</code> çš„æ ¸å¿ƒä»£ç ï¼š</p>
<pre><code class="language-tsx"><span class="hljs-comment">// packages/universal/src/bundler/react/plugins/virtual-entry/server.tsx</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Server</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@speedy-js/universal/components&#x27;</span>;
<span class="hljs-keyword">import</span> type { <span class="hljs-title class_">ServerSideRenderContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@speedy-js/universal/interface&#x27;</span>;
<span class="hljs-comment">// @ts-ignore, __ENTRY_PATH__ è¦è¢«æ›¿æ¢ä¸ºå®é™…çš„è·¯å¾„æ‰èƒ½å®ç°å°è£…</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Entry</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;__ENTRY_PATH__&#x27;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">Component</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>&lt;<span class="hljs-title class_">ServerSideRenderContext</span>&gt; = <span class="hljs-function">(<span class="hljs-params">props</span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> (
    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Server</span> {<span class="hljs-attr">...props</span>}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Entry</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Server</span>&gt;</span></span>
  );
};

</code></pre>
<pre><code class="language-ts"><span class="hljs-keyword">import</span> serverVirtualEntryCode <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./virtual-entry/server?raw&#x27;</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> serverPlugin = ({ appContext, root }: <span class="hljs-title class_">ServerPluginOptions</span>): <span class="hljs-function"><span class="hljs-params">SpeedyPlugin</span> =&gt;</span> {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">name</span>: <span class="hljs-variable constant_">SERVER_PLUGIN_NAME</span>,
    <span class="hljs-title function_">apply</span>(<span class="hljs-params">compiler</span>) {
      <span class="hljs-comment">// ...</span>
      compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">load</span>.<span class="hljs-title function_">tapPromise</span>(<span class="hljs-variable constant_">SERVER_PLUGIN_NAME</span>, <span class="hljs-keyword">async</span> (args) =&gt; {
        <span class="hljs-comment">// ...</span>
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(<span class="hljs-variable constant_">VIRTUAL_ENTRY_SUFFIX</span>).<span class="hljs-title function_">test</span>(args.<span class="hljs-property">path</span>)) {
          <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">const</span> { query } = <span class="hljs-title function_">resolvePathAndQuery</span>(args.<span class="hljs-property">path</span>);

        <span class="hljs-keyword">const</span> pageName = query[<span class="hljs-variable constant_">QUERY_PAGE_NAME</span>];

        <span class="hljs-keyword">if</span> (!pageName) {
          <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">const</span> page = appContext.<span class="hljs-title function_">getPageByName</span>(pageName)!;

        <span class="hljs-keyword">const</span> entryPath = page.<span class="hljs-property">entry</span>;
        <span class="hljs-keyword">const</span> prefetchPath = page.<span class="hljs-property">prefetch</span>;

        <span class="hljs-keyword">const</span> <span class="hljs-attr">entryPoints</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt; = {
          <span class="hljs-attr">server</span>: entryPath,
        };

        <span class="hljs-keyword">if</span> (prefetchPath) {
          entryPoints.<span class="hljs-property">prefetch</span> = prefetchPath;
        }

        <span class="hljs-keyword">const</span> buildResult = esbuild.<span class="hljs-title function_">buildSync</span>({
          <span class="hljs-attr">absWorkingDir</span>: root,
          entryPoints,
          <span class="hljs-attr">outdir</span>: root,
          <span class="hljs-attr">metafile</span>: <span class="hljs-literal">true</span>,
          <span class="hljs-attr">write</span>: <span class="hljs-literal">false</span>,
        });

        <span class="hljs-keyword">const</span> entryExportedNames = buildResult.<span class="hljs-property">metafile</span>?.<span class="hljs-property">outputs</span>[<span class="hljs-string">&#x27;server.js&#x27;</span>].<span class="hljs-property">exports</span>;

        <span class="hljs-keyword">const</span> relativeEntryPath = path.<span class="hljs-title function_">relative</span>(root, entryPath);
        <span class="hljs-keyword">if</span> (!entryExportedNames?.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&#x27;default&#x27;</span>)) {
          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`The component should be exported by default, file: <span class="hljs-subst">${relativeEntryPath}</span>`</span>);
        }

        <span class="hljs-keyword">const</span> prefetchExportedNames = buildResult.<span class="hljs-property">metafile</span>?.<span class="hljs-property">outputs</span>?.[<span class="hljs-string">&#x27;prefetch.js&#x27;</span>]?.<span class="hljs-property">exports</span>;

        <span class="hljs-keyword">const</span> hasPrefetch = !!prefetchExportedNames;
        <span class="hljs-keyword">const</span> isSSG = prefetchExportedNames?.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&#x27;getStaticProps&#x27;</span>);
        <span class="hljs-keyword">const</span> isSSR = prefetchExportedNames?.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&#x27;default&#x27;</span>);

        <span class="hljs-keyword">const</span> relativePrefetchPath = prefetchPath &amp;&amp; path.<span class="hljs-title function_">relative</span>(root, prefetchPath);
        <span class="hljs-keyword">if</span> (hasPrefetch) {
          <span class="hljs-keyword">if</span> (isSSG &amp;&amp; isSSR) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(
              <span class="hljs-string">`Cannot export both &#x27;getStaticProps&#x27; and &#x27;default&#x27; at the same time in prefetch entry, please remove one of them, file: <span class="hljs-subst">${relativePrefetchPath}</span>`</span>
            );
          }
          <span class="hljs-keyword">if</span> (!isSSG &amp;&amp; !isSSR &amp;&amp; prefetchExportedNames) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(
              <span class="hljs-string">`Should export one of &#x27;getStaticProps&#x27; or &#x27;default&#x27; in prefetch entry, file: <span class="hljs-subst">${relativePrefetchPath}</span>`</span>
            );
          }
        }

        <span class="hljs-keyword">const</span> entryHelper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">EntryHelper</span>(serverVirtualEntryCode);

        entryHelper.<span class="hljs-title function_">replace</span>(__ENTRY_PATH__, <span class="hljs-string">`./<span class="hljs-subst">${relativeEntryPath}</span>`</span>);
        <span class="hljs-keyword">if</span> (hasPrefetch) {
          entryHelper.<span class="hljs-title function_">addReExport</span>({
            <span class="hljs-attr">exportName</span>: isSSR ? <span class="hljs-string">&#x27;default as getServerSideProps&#x27;</span> : <span class="hljs-string">&#x27;getStaticProps&#x27;</span>,
            <span class="hljs-attr">filepath</span>: <span class="hljs-string">`./<span class="hljs-subst">${relativePrefetchPath}</span>`</span>,
          });
        }

        <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">loader</span>: <span class="hljs-string">&#x27;tsx&#x27;</span>,
          <span class="hljs-attr">resolveDir</span>: root,
          <span class="hljs-attr">contents</span>: entryHelper.<span class="hljs-title function_">toString</span>(),
        };
      })
</code></pre>
<p>ä¸‹é¢æ˜¯ <code>basic</code> ä¸ºä¾‹å­ç”Ÿæˆçš„ <code>server/ssr.js</code> çš„ç®€åŒ–ç‰ˆæœ¬:</p>
<pre><code class="language-js"><span class="hljs-comment">// server/ssr.js</span>
<span class="hljs-comment">// React ç»„ä»¶</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Component</span>(<span class="hljs-params"></span>) {}
<span class="hljs-comment">// æ•°æ®é¢„å–å‡½æ•°</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getServerSideProps</span>(<span class="hljs-params"></span>){}
</code></pre>
<h3 id="server-å®ç°">Server å®ç°</h3>
<p><code>BaseServer</code> ä¸­ä¹Ÿæ˜¯åŒ…å«äº†ä¸€äº›é€šç”¨é€»è¾‘ï¼Œå¼€å‘æ¨¡å¼å’Œç”Ÿäº§æ¨¡å¼åˆ†åˆ«å®ç°å­ç±»ã€‚é€šç”¨é€»è¾‘æœ‰ï¼š</p>
<ul>
<li>
<p>åˆå§‹åŒ–ä¸€äº› Polyfill ï¼Œè¿™äº› Polyfill ç”¨äº Node.js ä¸­è¿è¡Œä¸€äº›æµè§ˆå™¨å¸¸ç”¨çš„ APIï¼Œä¾‹å¦‚ <code>atob</code>, <code>btoa</code>, fetch API çš„ <code>Headers</code>, <code>Request</code> å’Œ <code>Response</code> ç­‰ï¼Œå‚è€ƒäº† remix-node è¿›è¡Œå®ç°ã€‚</p>
</li>
<li>
<p>å®šä¹‰ä¸€ä¸ª Connect å®ä¾‹ <code>middlewares</code>ï¼Œè´Ÿè´£ä¸²è”æœåŠ¡å™¨çš„æ‰€æœ‰é€»è¾‘ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡å‘ <code>middlewares</code> ä¸­ <code>push</code> æ–°çš„å¤„ç†å‡½æ•°æ¥è‡ªå®šä¹‰æœåŠ¡å™¨çš„è¡Œä¸ºã€‚</p>
</li>
<li>
<p><code>prepare</code> å‡½æ•°ï¼Œä¾› Server å†…éƒ¨æ‰§è¡Œä¸€äº›å¼‚æ­¥å‡½æ•°ï¼Œç¡®ä¿å¼‚æ­¥å‡½æ•°æ‰§è¡Œå®Œä¹‹åå†è°ƒç”¨ Server çš„å…·ä½“æ–¹æ³•ã€‚</p>
</li>
<li>
<p><code>handleStatic</code> å¤„ç†é™æ€èµ„æºçš„é€»è¾‘ã€‚</p>
</li>
<li>
<p><code>handleServerSideRequest</code> å¤„ç†æœåŠ¡ç«¯è¯·æ±‚ã€‚åŒ…å« SSR è¯·æ±‚æ—¶ï¼ŒæœåŠ¡ç«¯çš„é€»è¾‘ï¼Œä¼šæ‰§è¡Œ server äº§ç‰©ä¸­çš„æ•°æ®é¢„å–å‡½æ•°å¹¶å®Œæˆè„±æ°´æµç¨‹ã€‚</p>
<pre><code class="language-ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseServer</span> {
  <span class="hljs-comment">// ...</span>
  handleServerSideRequest = <span class="hljs-keyword">async</span> (<span class="hljs-attr">req</span>: <span class="hljs-title class_">IncomingMessage</span>, <span class="hljs-attr">res</span>: <span class="hljs-title class_">ServerResponse</span>) =&gt; {
      <span class="hljs-keyword">const</span> { framework, pages, baseUrl } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">ssrOptions</span>;
      <span class="hljs-keyword">const</span> { dev, root } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>;

      <span class="hljs-keyword">if</span> (!req.<span class="hljs-property">url</span>) {
        <span class="hljs-keyword">return</span>;
      }

      <span class="hljs-keyword">const</span> url = <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(req.<span class="hljs-property">url</span>, <span class="hljs-string">`http://<span class="hljs-subst">${req.headers.host}</span>`</span>);

      <span class="hljs-keyword">const</span> matchedPage = <span class="hljs-title function_">matchPage</span>({
        pages,
        <span class="hljs-attr">pathname</span>: url.<span class="hljs-property">pathname</span>,
        baseUrl,
      });

      <span class="hljs-keyword">const</span> { prefetchTypeMap } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">manifest</span>;

      <span class="hljs-keyword">if</span> (matchedPage?.<span class="hljs-property">name</span>) {
        <span class="hljs-comment">// production, serve page as static files</span>
        <span class="hljs-keyword">if</span> (prefetchTypeMap[matchedPage.<span class="hljs-property">name</span>] === <span class="hljs-variable constant_">PREFETCH_TYPE</span>.<span class="hljs-property">SSG</span> &amp;&amp; !dev) {
          <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">const</span> template = fs.<span class="hljs-title function_">readFileSync</span>(<span class="hljs-title function_">getHtmlPath</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">dist</span>, matchedPage.<span class="hljs-property">name</span>), <span class="hljs-string">&#x27;utf-8&#x27;</span>);

        <span class="hljs-keyword">if</span> (url.<span class="hljs-property">searchParams</span>.<span class="hljs-title function_">has</span>(<span class="hljs-string">&#x27;csr&#x27;</span>)) {
          <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">end</span>(template);
        }

        <span class="hljs-comment">// should not cache html files in browser</span>
        <span class="hljs-comment">// https://nextjs.org/docs/going-to-production#caching</span>
        res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">&#x27;Cache-Control&#x27;</span>, <span class="hljs-string">&#x27;no-cache, no-store, max-age=0, must-revalidate&#x27;</span>);

        <span class="hljs-keyword">if</span> (framework === <span class="hljs-string">&#x27;react&#x27;</span>) {
          <span class="hljs-comment">// Renderer å†…éƒ¨ä¼šæ ¹æ®å½“å‰è¯·æ±‚é¡µé¢æ˜¯ SSR è¿˜æ˜¯ SSG å»è¿›è¡Œä¸åŒçš„æ¸²æŸ“é€»è¾‘ï¼›å¯ä»¥ç›´æ¥æ ¹æ®æ„å»ºäº§ç‰©çš„ export åç§°æ¥åˆ¤æ–­</span>
          <span class="hljs-keyword">const</span> renderer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Renderer</span>({
            baseUrl,
            <span class="hljs-attr">dist</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">dist</span>,
            matchedPage,
            <span class="hljs-attr">name</span>: matchedPage.<span class="hljs-property">name</span>,
            template,
            pages,
            root,
            dev,
            <span class="hljs-attr">pageMeta</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">manifest</span>.<span class="hljs-property">entryMeta</span>[matchedPage.<span class="hljs-property">name</span>],
            <span class="hljs-attr">assetsMeta</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">manifest</span>.<span class="hljs-property">assetsMeta</span> ?? {},
            <span class="hljs-attr">isModule</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">manifest</span>.<span class="hljs-property">format</span> === <span class="hljs-string">&#x27;esm&#x27;</span>,
          });
          <span class="hljs-comment">// å€Ÿé‰´äº† Remix çš„æ€æƒ³ï¼Œå°†æ‰€æœ‰è¯·æ±‚è½¬åŒ–ä¸º fetch API req/res æ¥è¿›è¡Œå¤„ç†ï¼Œrenderer åªéœ€è€ƒè™‘ fetch API å³å¯</span>
          <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">withFetchAPI</span>(req, res, <span class="hljs-keyword">async</span> (request) =&gt; {
            <span class="hljs-keyword">return</span> renderer.<span class="hljs-title function_">render</span>(request);
          });
          <span class="hljs-keyword">return</span> response;
        }
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`universal server for framework <span class="hljs-subst">${framework}</span> has not been implemented`</span>);
      }
    };
}
</code></pre>
</li>
</ul>
<p><code>DevServer</code> éœ€è¦å¢åŠ  <code>handleStatic</code> å‡½æ•°çš„é€»è¾‘ï¼Œç”±äº Speedy å†…éƒ¨å·²ç»å®ç°äº†å¯¹é™æ€èµ„æºçš„ serverï¼Œç›´æ¥å¯¹å…¶è¿›è¡Œä»£ç†å³å¯ï¼š</p>
<pre><code class="language-ts"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DevServer</span> {
  <span class="hljs-comment">// ...</span>
  <span class="hljs-attr">handleRequest</span>: <span class="hljs-title class_">SimpleHandleFunction</span> = <span class="hljs-keyword">async</span> (<span class="hljs-attr">req</span>: <span class="hljs-title class_">IncomingMessage</span>, <span class="hljs-attr">res</span>: <span class="hljs-title class_">ServerResponse</span>) =&gt; {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setHttpProxyHandler</span>(req);
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> resp = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleServerSideRequest</span>(req, res);
        <span class="hljs-keyword">if</span> (resp) {
          <span class="hljs-keyword">return</span>;
        }
      } <span class="hljs-keyword">catch</span> (e) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(e);
      }

      <span class="hljs-keyword">if</span> (path.<span class="hljs-title function_">parse</span>(req.<span class="hljs-property">url</span> ?? <span class="hljs-string">&#x27;/&#x27;</span>).<span class="hljs-property">ext</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleStatic</span>(req, res);
      }

      <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">end</span>(<span class="hljs-title function_">renderNotFound</span>());
    };
  <span class="hljs-attr">handleStatic</span>: <span class="hljs-title class_">SimpleHandleFunction</span> = <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> httpProxy = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getHttpProxy</span>();
    <span class="hljs-comment">// https://nextjs.org/docs/going-to-production#caching</span>
    res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">&#x27;Cache-Control&#x27;</span>, <span class="hljs-string">&#x27;no-cache, no-store, max-age=0, must-revalidate&#x27;</span>);
    httpProxy.<span class="hljs-title function_">web</span>(req, res);
  };
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>å¯¹äº <code>ProdServer</code>ï¼Œåˆ™æœ‰ä¸åŒçš„ <code>handleStatic</code> é€»è¾‘ï¼Œä»äº§ç‰©ä¸­è¿›è¡Œ serve:</p>
<pre><code class="language-ts"><span class="hljs-attr">handleStatic</span>: <span class="hljs-title class_">Connect</span>.<span class="hljs-property">SimpleHandleFunction</span> = <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> { <span class="hljs-attr">url</span>: reqUrl = <span class="hljs-string">&#x27;&#x27;</span> } = req;
  <span class="hljs-keyword">const</span> publicPath = <span class="hljs-title function_">getPublicPath</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">manifest</span>.<span class="hljs-property">publicPath</span>);
  <span class="hljs-keyword">const</span> { baseUrl } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">ssrOptions</span>;
  <span class="hljs-keyword">const</span> name = reqUrl
    .<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;?&#x27;</span>)[<span class="hljs-number">0</span>]
    .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/.html?$/</span>, <span class="hljs-string">&#x27;&#x27;</span>)
    .<span class="hljs-title function_">replace</span>(baseUrl, <span class="hljs-string">&#x27;&#x27;</span>)
    .<span class="hljs-title function_">slice</span>(baseUrl === <span class="hljs-string">&#x27;/&#x27;</span> ? <span class="hljs-number">0</span> : <span class="hljs-number">1</span>);

  <span class="hljs-keyword">const</span> filename = <span class="hljs-title function_">getFilenameFromUrl</span>(<span class="hljs-string">`/<span class="hljs-subst">${name ?? <span class="hljs-string">&#x27;&#x27;</span>}</span>`</span>, [
    {
      publicPath,
      <span class="hljs-attr">outputPath</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">dist</span>,
    },
  ]);

  <span class="hljs-keyword">if</span> (!filename || !fs.<span class="hljs-title function_">existsSync</span>(filename) || fs.<span class="hljs-title function_">lstatSync</span>(filename).<span class="hljs-title function_">isDirectory</span>()) {
    res.<span class="hljs-property">statusCode</span> = <span class="hljs-number">404</span>;
    res.<span class="hljs-title function_">end</span>(<span class="hljs-string">&#x27;Page Not Found&#x27;</span>);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">const</span> reqPath = <span class="hljs-built_in">decodeURI</span>(url.<span class="hljs-title function_">parse</span>(reqUrl).<span class="hljs-property">pathname</span> || <span class="hljs-string">&#x27;&#x27;</span>);

  <span class="hljs-keyword">const</span> mimeType = <span class="hljs-title function_">lookup</span>(reqPath) || <span class="hljs-title function_">lookup</span>(filename);
  <span class="hljs-keyword">if</span> (mimeType) {
    res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">&#x27;Content-Type&#x27;</span>, mimeType);
  }

  res.<span class="hljs-property">statusCode</span> = <span class="hljs-number">200</span>;
  <span class="hljs-comment">// https://developers.google.com/web/fundamentals/performance/webpack/use-long-term-caching</span>
  <span class="hljs-comment">// https://nextjs.org/docs/going-to-production#caching</span>
  res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">&#x27;Cache-Control&#x27;</span>, <span class="hljs-string">&#x27;public, max-age=31536000, immutable&#x27;</span>);
  fs.<span class="hljs-title function_">createReadStream</span>(filename).<span class="hljs-title function_">pipe</span>(res);
};
</code></pre>
<p>ç„¶åæˆ‘ä»¬å®ç°äº† <code>universal</code> è¿™ä¸ªè„šæœ¬ï¼Œæ·»åŠ  <code>universal dev</code> å’Œ <code>universal build</code> åˆ†åˆ«æ¥è¿›è¡Œå¼€å‘å’Œæ„å»ºï¼Œå¯ä»¥ç”¨ <code>universal start</code> æ¥å¯åŠ¨ <code>ProdServer</code>ã€‚</p>
<h3 id="adapter-å®ç°">Adapter å®ç°</h3>
<p>ä¸ºäº†è®©æˆ‘ä»¬çš„ä»£ç ä¸ä»…èƒ½åœ¨ Node.js ç¯å¢ƒä¸‹é¢é€šè¿‡ <code>universal</code> CLI æ¥éƒ¨ç½²ï¼Œè¿˜æƒ³åœ¨ Vercel å’Œ CloudFlare ä»¥åŠå…¬å¸å†…çš„å…¶ä»– Serverless æˆ–è€… Edge ä¸Šéƒ¨ç½²ï¼Œæˆ‘ä»¬å‚è€ƒäº† <a href="https://remix.run/docs/en/main/other-api/adapter">Remix Adapter</a> çš„æ€æƒ³æ¥æ”¯æŒä¸åŒçš„é€‚é…å™¨ï¼Œå®ç°ä¸åŒç¯å¢ƒéƒ¨ç½²ã€‚</p>
<p>ä¾‹å¦‚ Vercel Adapter å®ç°å¦‚ä¸‹:</p>
<pre><code class="language-ts"><span class="hljs-comment">// packages/universal/src/adapters/vercel/index.ts</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">IncomingMessage</span>, <span class="hljs-title class_">ServerResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;http&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ProdServer</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../../server/prod-server&#x27;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">VercelAdapterOptions</span> {
  root?: <span class="hljs-built_in">string</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createVercelHandler</span>(<span class="hljs-params">{ root = process.cwd() }: VercelAdapterOptions = {}</span>): <span class="hljs-function">(<span class="hljs-params">
  req: IncomingMessage,
  res: ServerResponse
</span>) =&gt;</span> <span class="hljs-built_in">void</span> {
  <span class="hljs-keyword">const</span> server = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProdServer</span>({ root });

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span> (<span class="hljs-attr">req</span>: <span class="hljs-title class_">IncomingMessage</span>, <span class="hljs-attr">res</span>: <span class="hljs-title class_">ServerResponse</span>) =&gt; {
    <span class="hljs-keyword">await</span> server.<span class="hljs-title function_">prepare</span>();

    <span class="hljs-keyword">const</span> handler = server.<span class="hljs-title function_">getRequestHandler</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">handler</span>(req, res);
  };
}

</code></pre>
<p>åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º <code>server.vercel.js</code>:</p>
<pre><code class="language-js"><span class="hljs-comment">// server.vercel.js</span>
<span class="hljs-comment">// @ts-check</span>

<span class="hljs-keyword">const</span> { createVercelHandler } = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;@speedy-js/universal/adapters/vercel&#x27;</span>);

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-title function_">createVercelHandler</span>();
</code></pre>
<p><code>vercel.json</code>:</p>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">&quot;version&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;public&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">false</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;github&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;enabled&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">false</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;builds&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;src&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;./server.vercel.js&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;use&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;@vercel/node&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;config&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">&quot;//&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;https://github.com/vercel/vercel/issues/1788#issuecomment-485629244&quot;</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">&quot;includeFiles&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;./.universal/**&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">&quot;bundle&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-keyword">false</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">&quot;maxLambdaSize&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;50mb&quot;</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">&quot;routes&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">&quot;src&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;/(.*)&quot;</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">&quot;dest&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;/server.vercel.js&quot;</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>

</code></pre>
<p>è¿è¡Œ <code>vercel --prod</code> å³å¯éƒ¨ç½²åˆ° Vercelã€‚</p>
<hr>
<p>CF Worker çš„ Adapter å®ç°ä¹Ÿå¾ˆç®€å•:</p>
<pre><code class="language-js"><span class="hljs-comment">/// &lt;reference lib=&quot;dom.iterable&quot;/&gt;</span>

<span class="hljs-keyword">import</span> { getAssetFromKV, <span class="hljs-title class_">MethodNotAllowedError</span>, <span class="hljs-title class_">NotFoundError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@cloudflare/kv-asset-handler&#x27;</span>;
<span class="hljs-keyword">import</span> type { <span class="hljs-title class_">CloudflareBuildManifest</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./interface&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">PREFETCH_TYPE</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../../interface&#x27;</span>;
<span class="hljs-keyword">import</span> { renderToHTML } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../../helpers/render&#x27;</span>;
<span class="hljs-keyword">import</span> { getQuery } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../../helpers/getQuery&#x27;</span>;
<span class="hljs-keyword">import</span> { matchPage, <span class="hljs-title class_">PageMatch</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../../helpers/matchPage&#x27;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">FetchEvent</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../../../client&#x27;</span>;

<span class="hljs-keyword">export</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./interface&#x27;</span>;

<span class="hljs-keyword">export</span> interface <span class="hljs-title class_">CloudflareWorkerAdapterOptions</span> {
  dev?: boolean;
  root?: string;
  <span class="hljs-attr">manifest</span>: <span class="hljs-title class_">CloudflareBuildManifest</span>;
}

<span class="hljs-keyword">export</span> interface <span class="hljs-title class_">CloudflareWorkerServerOptions</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">CloudflareWorkerAdapterOptions</span> {
  <span class="hljs-attr">event</span>: <span class="hljs-title class_">FetchEvent</span>;
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CloudflareWorkerServer</span> {
  <span class="hljs-attr">options</span>: <span class="hljs-title class_">CloudflareWorkerServerOptions</span>;

  <span class="hljs-attr">pathname</span>: string;

  <span class="hljs-attr">origin</span>: string;

  <span class="hljs-attr">url</span>: <span class="hljs-variable constant_">URL</span>;

  <span class="hljs-attr">matchedPage</span>: <span class="hljs-title class_">PageMatch</span> | <span class="hljs-literal">undefined</span>;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">options: CloudflareWorkerServerOptions</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span> = options;

    <span class="hljs-keyword">const</span> { event } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">url</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(event.<span class="hljs-property">request</span>.<span class="hljs-property">url</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pathname</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">url</span>.<span class="hljs-property">pathname</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">origin</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">url</span>.<span class="hljs-property">origin</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">matchedPage</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">matchPageName</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">pathname</span>)!;
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">handleAssets</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Response</span>&gt; {
    <span class="hljs-keyword">const</span> { pathname } = <span class="hljs-variable language_">this</span>;
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-title function_">getAssetFromKV</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">event</span>, {
        <span class="hljs-attr">mapRequestToAsset</span>: <span class="hljs-function">(<span class="hljs-params">request</span>) =&gt;</span> {
          <span class="hljs-comment">// è¿™é‡Œä½¿ç”¨äº† manifest æ–‡ä»¶</span>
          <span class="hljs-keyword">const</span> { baseUrl } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">manifest</span>.<span class="hljs-property">ssrOptions</span>;
          <span class="hljs-keyword">if</span> (pathname.<span class="hljs-title function_">startsWith</span>(baseUrl)) {
            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">matchedPage</span>?.<span class="hljs-property">name</span>) {
              <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Request</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.matchedPage.name}</span>.html`</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">origin</span>).<span class="hljs-property">href</span>);
            }
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Request</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(pathname.<span class="hljs-title function_">replace</span>(baseUrl, <span class="hljs-string">&#x27;&#x27;</span>), <span class="hljs-variable language_">this</span>.<span class="hljs-property">origin</span>).<span class="hljs-property">href</span>);
          }
          <span class="hljs-keyword">return</span> request;
        },
      });
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">NotFoundError</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(<span class="hljs-string">&#x27;NotFoundError&#x27;</span>, { <span class="hljs-attr">status</span>: <span class="hljs-number">404</span> });
      }
      <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">MethodNotAllowedError</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(<span class="hljs-string">&#x27;MethodNotAllowedError&#x27;</span>, { <span class="hljs-attr">status</span>: <span class="hljs-number">500</span> });
      }
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(<span class="hljs-string">&#x27;An unexpected error occurred&#x27;</span>, { <span class="hljs-attr">status</span>: <span class="hljs-number">500</span> });
    }
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getAsset</span>(<span class="hljs-attr">url</span>: string): <span class="hljs-title class_">Promise</span>&lt;string&gt; {
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getAssetFromKV</span>({
      <span class="hljs-attr">request</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Request</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(url, <span class="hljs-variable language_">this</span>.<span class="hljs-property">origin</span>).<span class="hljs-property">href</span>),
      <span class="hljs-attr">waitUntil</span>: <span class="hljs-function">() =&gt;</span> {},
    });
    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">text</span>();
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">handleSSRRequest</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Response</span>&gt; {
    <span class="hljs-keyword">const</span> {
      manifest,
      <span class="hljs-attr">event</span>: { request },
    } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>;
    <span class="hljs-keyword">const</span> { pathname, search } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">url</span>;
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">matchedPage</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(<span class="hljs-string">&#x27;No matched SSR page&#x27;</span>, { <span class="hljs-attr">status</span>: <span class="hljs-number">404</span> });

    <span class="hljs-keyword">const</span> templateHtmlPath = <span class="hljs-string">`/<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.matchedPage.name}</span>.html`</span>;
    <span class="hljs-keyword">const</span> template = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getAsset</span>(templateHtmlPath);

    <span class="hljs-keyword">const</span> { <span class="hljs-title class_">Component</span>, getServerSideProps } = manifest.<span class="hljs-property">exportsMap</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">matchedPage</span>.<span class="hljs-property">name</span>].<span class="hljs-property">server</span>;
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>();
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> html = <span class="hljs-keyword">await</span> <span class="hljs-title function_">renderToHTML</span>({
        <span class="hljs-title class_">Component</span>,
        getServerSideProps,
        <span class="hljs-attr">assetsMeta</span>: manifest.<span class="hljs-property">assetsMeta</span>,
        <span class="hljs-attr">basename</span>: manifest.<span class="hljs-property">ssrOptions</span>.<span class="hljs-property">baseUrl</span>,
        template,
        <span class="hljs-attr">pages</span>: manifest.<span class="hljs-property">ssrOptions</span>.<span class="hljs-property">pages</span>,
        <span class="hljs-attr">matchedPage</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">matchedPage</span>,
        <span class="hljs-attr">context</span>: {
          request,
          response,
          pathname,
          <span class="hljs-attr">query</span>: <span class="hljs-title function_">getQuery</span>(search),
        },
        <span class="hljs-attr">isModule</span>: manifest.<span class="hljs-property">format</span> === <span class="hljs-string">&#x27;esm&#x27;</span>,
      });
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(html, {
        ...response,
        <span class="hljs-attr">headers</span>: { ...<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">fromEntries</span>(response.<span class="hljs-property">headers</span>.<span class="hljs-title function_">entries</span>()), <span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;text/html&#x27;</span> },
      });
    } <span class="hljs-keyword">catch</span> (<span class="hljs-attr">err</span>: any) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Error when calling render function of server file: <span class="hljs-subst">${templateHtmlPath}</span>`</span>);
    }
  }

  <span class="hljs-title function_">matchPageName</span>(<span class="hljs-params">pathname: string</span>) {
    <span class="hljs-keyword">const</span> { ssrOptions } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">manifest</span>;
    <span class="hljs-keyword">const</span> match = <span class="hljs-title function_">matchPage</span>({ <span class="hljs-attr">pages</span>: ssrOptions.<span class="hljs-property">pages</span>, pathname, <span class="hljs-attr">baseUrl</span>: ssrOptions.<span class="hljs-property">baseUrl</span> });
    <span class="hljs-keyword">return</span> match;
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">handleRequest</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">const</span> { request } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">event</span>;
    <span class="hljs-keyword">const</span> { ssrOptions, prefetchTypeMap, exportsMap } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">manifest</span>;
    <span class="hljs-keyword">const</span> { framework } = ssrOptions;

    <span class="hljs-keyword">const</span> { searchParams } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">url</span>;
    <span class="hljs-keyword">if</span> (searchParams.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;__data&#x27;</span>)) {
      <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">matchedPage</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(<span class="hljs-string">&#x27;No matched SSR page for data&#x27;</span>, { <span class="hljs-attr">status</span>: <span class="hljs-number">404</span> });
      }
      <span class="hljs-keyword">const</span> { getServerSideProps } = exportsMap[<span class="hljs-variable language_">this</span>.<span class="hljs-property">matchedPage</span>.<span class="hljs-property">name</span>].<span class="hljs-property">server</span>;
      <span class="hljs-keyword">if</span> (!getServerSideProps) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(<span class="hljs-string">&#x27;No matched SSR export getServerSideProps for data&#x27;</span>, { <span class="hljs-attr">status</span>: <span class="hljs-number">404</span> });
      }
      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>();
      <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getServerSideProps</span>({
        request,
        response,
        <span class="hljs-attr">pathname</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">pathname</span> ?? <span class="hljs-string">&#x27;/&#x27;</span>,
        <span class="hljs-attr">query</span>: searchParams,
      });
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data), {
        ...response,
        <span class="hljs-attr">headers</span>: {
          ...<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">fromEntries</span>(response.<span class="hljs-property">headers</span>.<span class="hljs-title function_">entries</span>()),
          <span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;application/json&#x27;</span>,
        },
      });
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">matchedPage</span>?.<span class="hljs-property">name</span>) {
      <span class="hljs-keyword">if</span> (prefetchTypeMap[<span class="hljs-variable language_">this</span>.<span class="hljs-property">matchedPage</span>.<span class="hljs-property">name</span>] === <span class="hljs-variable constant_">PREFETCH_TYPE</span>.<span class="hljs-property">SSR</span>) {
        <span class="hljs-keyword">if</span> (framework === <span class="hljs-string">&#x27;react&#x27;</span>) {
          <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleSSRRequest</span>();
        }
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`universal server for framework <span class="hljs-subst">${framework}</span> has not been implemented`</span>);
      }
    }
    <span class="hljs-comment">// å…¶ä»–æƒ…å†µçš„è¯æ˜¯é™æ€èµ„æºï¼Œä½¿ç”¨ CF Worker çš„ KV å­˜å‚¨å¤„ç†ï¼Œæ„å»ºäº§ç‰©éœ€è¦ä¸Šä¼ åˆ° KV å­˜å‚¨</span>
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleAssets</span>();
  }
}

<span class="hljs-comment">// ç»™çš„æ˜¯ fetchAPI Requestï¼Œæˆ‘ä»¬è¦è¿”å› fetchAPI Response</span>
<span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> proxy the web socket connection when developing</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createCloudflareWorkerHandler</span>(<span class="hljs-params">options: CloudflareWorkerAdapterOptions</span>): <span class="hljs-function">(<span class="hljs-params">event: FetchEvent</span>) =&gt;</span> <span class="hljs-keyword">void</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> server = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CloudflareWorkerServer</span>({
      ...options,
      event,
    });
    event.<span class="hljs-title function_">respondWith</span>(server.<span class="hljs-title function_">handleRequest</span>());
  };
}

</code></pre>
<p>å…¶ä¸­ç”¨åˆ°äº† manifest æ–‡ä»¶æ¥å®ç°å¯¼å…¥å¯¹åº”é¡µé¢çš„ä»£ç ï¼Œmanifest æ˜¯ç”± <code>clientPlugin</code> ç”Ÿæˆçš„:</p>
<p><img src="https://s2.loli.net/2023/05/21/WAzLY2lEGQxvdft.png" alt="manifest"></p>
<p>é…ç½® <code>wrangler.toml</code>:</p>
<pre><code class="language-toml"><span class="hljs-attr">name</span> = <span class="hljs-string">&quot;ssr-react-example&quot;</span>
<span class="hljs-attr">type</span> = <span class="hljs-string">&quot;javascript&quot;</span>

<span class="hljs-attr">zone_id</span> = <span class="hljs-string">&quot;&quot;</span>
<span class="hljs-attr">account_id</span> = <span class="hljs-string">&quot;&quot;</span>
<span class="hljs-attr">route</span> = <span class="hljs-string">&quot;&quot;</span>
<span class="hljs-attr">workers_dev</span> = <span class="hljs-literal">true</span>

<span class="hljs-section">[site]</span>
<span class="hljs-comment"># These two settings are necessary to save the assets to CF KV storage</span>
<span class="hljs-comment"># https://developers.cloudflare.com/workers/cli-wrangler/commands#kvkey</span>
<span class="hljs-comment"># https://developers.cloudflare.com/workers/cli-wrangler/configuration#site</span>
<span class="hljs-attr">bucket</span> = <span class="hljs-string">&quot;.universal&quot;</span>
<span class="hljs-attr">entry-point</span> = <span class="hljs-string">&quot;.&quot;</span>

<span class="hljs-section">[build]</span>
<span class="hljs-attr">command</span> = <span class="hljs-string">&quot;pnpm build:cf-worker&quot;</span>
<span class="hljs-attr">watch_dir</span> = <span class="hljs-string">&quot;src&quot;</span>

<span class="hljs-section">[build.upload]</span>
<span class="hljs-attr">format</span>=<span class="hljs-string">&quot;service-worker&quot;</span>

</code></pre>
<p>éƒ¨ç½²çš„è¯è¿è¡Œ <code>wrangler publish</code> å³å¯ã€‚</p>
<h2 id="æ€»ç»“ä¸æ€è€ƒ">æ€»ç»“ä¸æ€è€ƒ</h2>
<p>æœ¬æ–‡ä»‹ç»çš„æ˜¯ Speedy çš„ SSR å®ç°ï¼Œåœ¨å®ç° Speedy SSR çš„è¿‡ç¨‹ä¸­å‚è€ƒäº† Viteã€Next.js å’Œ Remixã€‚å…¶å®ä¸šç•Œçš„ SSR å®ç°æ€»ä½“æ€è·¯éƒ½æ˜¯åŸºæœ¬ä¸Šä¸€è‡´çš„ï¼Œä¸»è¦çš„ç‚¹æœ‰ï¼š</p>
<ul>
<li>ä¸€ä»½ä»£ç ï¼Œä¸¤ä»½äº§ç‰©ï¼Œå®ç°å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å¤ç”¨</li>
<li>å¼€å‘ä½“éªŒï¼ŒAPI è®¾è®¡ç®€æ´ï¼Œå¯æ‹“å±•æ€§å¼ºï¼Œå¼€å‘é€Ÿåº¦å¿«</li>
<li>éƒ¨ç½²åˆ°ä¸åŒçš„ç¯å¢ƒçš„æ”¯æŒ</li>
<li>æ€§èƒ½æå‡ï¼Œæœ€ç»ˆçš„ç›®æ ‡æ˜¯æå‡é¡µé¢çš„é¦–å±æ€§èƒ½ï¼Œè¾¾åˆ°ç§’å¼€çš„ç›®çš„ã€‚</li>
</ul>
<p>Speedy æœ€ç»ˆä»¥å¤±è´¥è€Œå‘Šç»ˆï¼Œå»å¹´å·²ç»é€æ¸ä¸å†ç»´æŠ¤äº†ï¼Œä¸»è¦è¿˜æ˜¯ esbuild çš„å…³æ³¨ç‚¹å’Œå…¶ä»–æ„å»ºå·¥å…·ä¸ä¸€æ ·ï¼Œä¾‹å¦‚ HMRã€æ‹†åŒ…ç­‰å°±åšçš„å¾ˆä¸å¥½ï¼›Rspack æˆä¸ºäº†å›¢é˜Ÿæ–°æ¨çš„æ„å»ºå·¥å…·ï¼Œä¸¤è€…éƒ½å€Ÿé‰´äº† Webpack çš„æ’ä»¶ä½“ç³»ï¼Œæƒ³åšçš„ä¸œè¥¿ä¹Ÿå¾ˆç±»ä¼¼ï¼Œå°±æ˜¯æå‡å¤§å®¶çš„å¼€å‘æ•ˆç‡ï¼Œä¸è¿‡æˆ‘æ²¡æœ‰å‚ä¸è¿‡ Rspack çš„å¼€å‘ï¼Œå°±ä¸æ˜¯å¾ˆç†Ÿæ‚‰äº†ã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2>
<ol>
<li><a href="http://www.ayqy.net/blog/diference-between-ssr-and-jsp-php/">SSRä¸å½“å¹´çš„JSPã€PHPæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</a></li>
<li><a href="https://vitejs.dev/guide/ssr.html">https://vitejs.dev/guide/ssr.html</a></li>
<li><a href="https://github.com/vitejs/vite/tree/main/packages/playground">https://github.com/vitejs/vite/tree/main/packages/playground</a></li>
<li><a href="https://github.com/frandiox/vite-ssr">https://github.com/frandiox/vite-ssr</a></li>
<li><a href="https://vitedge.js.org/">https://vitedge.js.org/</a></li>
<li><a href="https://vercel.com/guides/using-express-with-vercel">https://vercel.com/guides/using-express-with-vercel</a></li>
<li><a href="https://blog.cloudflare.com/serverless-rendering-with-cloudflare-workers/">https://blog.cloudflare.com/serverless-rendering-with-cloudflare-workers/</a></li>
<li><a href="https://next-code-elimination.vercel.app/">https://next-code-elimination.vercel.app/</a></li>
</ol>

        <script async src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script>
        
    </body>
    </html>