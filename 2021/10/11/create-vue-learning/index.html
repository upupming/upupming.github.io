<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="create-vue 发布并成为官方推荐，未来将替换 vue cli，看看 Vue Contributor Days 说了哪些内容（附 create-vue 源码解析）"><meta name="keywords" content="frontend"><meta name="author" content="upupming"><meta name="copyright" content="upupming"><title>create-vue 发布并成为官方推荐，未来将替换 vue cli，看看 Vue Contributor Days 说了哪些内容（附 create-vue 源码解析） | upupming 的博客</title><link rel="shortcut icon" href="/my-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css?version=1.6.1"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css?version=1.6.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.js" defer></script><link rel="manifest" href="/manifest.json"><link rel="manifest" href="/manifest.json"><meta name="theme-color" content="#1B9EF3"><meta name="msapplication-TileColor" content="#1B9EF3"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#1B9EF3"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: 'ca-pub-2188191456032650',
  enable_page_level_ads: 'true'
});
</script><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?295ad5c5a196e4964e20f74260711177";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><link rel="dns-prefetch" href="https://www.google-analytics.com"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-114899088-1', 'auto');
ga('send', 'pageview');</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"5WEDOKLFCL","apiKey":"26a57bfa5275b7c98a3b3ab7dae61915","indexName":"upupming-blog","hits":{"per_page":10},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容:${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#主要内容"><span class="toc-number">1.</span> <span class="toc-text"> 主要内容</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#create-vue-源码解析"><span class="toc-number">2.</span> <span class="toc-text"> create-vue 源码解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#整体流程"><span class="toc-number">2.1.</span> <span class="toc-text"> 整体流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#具体分析"><span class="toc-number">2.2.</span> <span class="toc-text"> 具体分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#支持-feature-flag"><span class="toc-number">2.2.1.</span> <span class="toc-text"> 支持 feature flag</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#render-函数"><span class="toc-number">2.2.2.</span> <span class="toc-text"> render 函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#deepmerge-和-sortdependencies"><span class="toc-number">2.2.3.</span> <span class="toc-text"> deepMerge 和 sortDependencies</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#清除旧项目-rm-rf"><span class="toc-number">2.2.4.</span> <span class="toc-text"> 清除旧项目 rm -rf</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#测试"><span class="toc-number">3.</span> <span class="toc-text"> 测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">4.</span> <span class="toc-text"> 总结</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/doraemon.jpeg"></div><div class="author-info__name text-center">upupming</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">52</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">44</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">27</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">友情链接</div><a class="author-info-links__name text-center" href="https://molunerfinn.com/">MARKSZのBlog</a><a class="author-info-links__name text-center" href="https://github.com/ryanhanwu/How-To-Ask-Questions-The-Smart-Way/blob/master/README-zh_CN.md">提问的智慧</a><a class="author-info-links__name text-center" href="https://zh.wikipedia.org/">中文维基百科</a><a class="author-info-links__name text-center" href="https://zbqtesla.github.io">ZBQTesla的博客</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/img/background.png)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">upupming 的博客</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">主页</a><a class="site-page" href="/archives">归档</a><a class="site-page" href="/tags">标签</a><a class="site-page" href="/categories">分类</a><a class="site-page" href="https://mirror.upupming.site">Mirror</a><a class="site-page" href="https://music.wxhbts.com">音乐</a><a class="site-page" href="https://writing.upupming.site">Writing</a><a class="site-page" href="/about">关于</a><a class="site-page" href="/rss">RSS</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title">create-vue 发布并成为官方推荐，未来将替换 vue cli，看看 Vue Contributor Days 说了哪些内容（附 create-vue 源码解析）</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-10-11</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/前端/">前端</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/前端/源码阅读/">源码阅读</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">3.6k</span><span class="post-meta__separator">|</span><span>阅读时长: 13 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><blockquote>
<p>原文链接放在我的 GitHub 上: <a href="https://github.com/upupming/frontend-learning-map/blob/main/daily-fe-problems/create-vue-learning.md" target="_blank" rel="noopener">https://github.com/upupming/frontend-learning-map/blob/main/daily-fe-problems/create-vue-learning.md</a> ，这也是我的前端学习路线，欢迎大家 Star~</p>
</blockquote>
<p>美国时间 2021 年 10 月 7 日早晨，This Dot Media 邀请了 Vue 的核心成员和 Vue Community （例如 Quasar, Ionic 开发者等）的一些主要贡献者举办了一个 Vue Contributor Days 在线会议，长达两个半小时，会上 vue-cli 的核心贡献者胖茶也在同一天公开了全新的脚手架工具 <a href="https://github.com/vuejs/create-vue" target="_blank" rel="noopener">create-vue</a>，我也是看到 antfu 发推就关注了一下，看完<a href="https://www.youtube.com/watch?v=gpTbH469Qog&amp;ab_channel=ThisDotMedia" target="_blank" rel="noopener">直播回放</a>之后收货很大，这里做一些总结并且分析一下最新发布的 create-vue 的源码。</p>
<p>主要关注了尤大的 talk，<a href="https://docs.google.com/presentation/d/137pQTDQI8O1FHzn2AtjL5tjeTnr8wbON7IonkcNyBVs/edit#slide=id.p" target="_blank" rel="noopener">PPT 链接</a>在这里，我转载到了<a href="https://github.com/upupming/frontend-learning-map/tree/main/slides/State_of_Vue_ThisDot_Meetup_Oct_2021.pdf" target="_blank" rel="noopener">我的 GitHub 上</a>，大家可以下载来看一下最新的进展，另外还有胖茶现场演示了如何使用 create-vue。</p>
<a id="more"></a>
<h2 id="主要内容"><a class="markdownIt-Anchor" href="#主要内容"></a> 主要内容</h2>
<p>Vue 3.2 在 2021.08.09 就已经发布了，最重要的就是 <code>&lt;script setup&gt;</code> 不再是实验阶段了，可以稳定使用。之前用过 composition API 的朋友都会觉得比较麻烦，<code>&lt;script setup&gt;</code> 主要是为了作为语法糖简化其写法，可以参考<a href="https://v3.vuejs.org/api/sfc-script-setup.html#basic-syntax" target="_blank" rel="noopener">文档</a>和 <a href="https://github.com/vuejs/rfcs/blob/master/active-rfcs/0040-script-setup.md" target="_blank" rel="noopener">RFC</a>。Vue 3.2 新增了一些新功能，如 <code>defineCustomElement</code> 和 <code>v-memo</code> 等等。</p>
<p>尤大还提到了新的 Ref Transform 提案，虽然现在 TS 环境下多一个 <code>.value</code> 没有什么太大的问题，类型提示能够自动补全做的很好，但是 Ref Transform 提案可以进一步简化省去 <code>.value</code> 这一步，而且 TS 支持也做好了：</p>
<p><img src="https://i.loli.net/2021/10/09/aTjy14CqsrX9cxN.png" alt="20211009173845"></p>
<p>使用 <code>cout = $ref(0)</code> 定义之后，使用 <code>count</code> 的时候会被编译成 <code>count.value</code>，同时还有一个反向操作 <code>$$</code>，重新把 reactive value 变成 ref。感觉这个简化确实很有前途，可能会被广泛使用。</p>
<p>另外 Vue 团队正在积极准备 3.3 版本，主要集中尽力在优化 SSR 相关的功能。可以期待一下。</p>
<p>尤大给出了最新的官方推荐：</p>
<p><img src="https://i.loli.net/2021/10/09/OLxTokw32Ild4gN.png" alt="20211009174500"></p>
<ul>
<li>推荐使用 create-vue 替换 vue cli，注意如果你的项目如果使用 vue cli 创建的，能够稳定使用的话，暂时没有提供转换成 create-vue 项目的方案，而且也不建议修改大型项目的基础配置。以后的新项目大家可以使用 create-vue 来创建更加快的应用，因为 create-vue 的模板项目都是基于 vite 来进行构建的了。</li>
<li>推荐使用 VSCode 的 Volar 插件而不是 Vetur 来获取更好的 TypeScript 支持（script setup 支持地很好, <code>vue-tsc</code> 表现和 volar 一致，因为都是用的一个 language service (@johnsoncodehk 开发的 <code>vscode-vue-languageservice</code>)），卸载 Vetur 安装 Volar 即可。</li>
<li>状态管理的话，正在考虑在 vuex next / Pinia (也是新出来的一个状态管理工具) / vue core 三者中考虑一个新的主推</li>
</ul>
<p>另外 Vue 3 的官方文档正在快速更新，新版的文档可以在 <a href="https://github.com/vuejs/docs/tree/next" target="_blank" rel="noopener">https://github.com/vuejs/docs/tree/next</a> 看到源码，部署在 <a href="https://vue-docs-preview.netlify.app/" target="_blank" rel="noopener">https://vue-docs-preview.netlify.app/</a> 。里面新增了许多 example，可以看 Options API 和 Composition API 两种格式，Composition API 已经都是用 <code>script setup</code> 来写的了，另外也有 HTML 和 SFC 两种不同的版本，感觉用 example 学起来方便很多。同时也提供了 tutorial 和 guide 两种学习方案，非常体贴。</p>
<p>胖茶介绍了 create-vue 的使用，令人兴奋的是，所有的模板现在的构建工具全部都是基于 vite 而不是 vue cli (Webpack) 的了，开发效率大大提升，同时使用 <code>cypress</code> 来作为自动测试的工具。之前 Vue 2 单元测试用的是 Jest，但是 Jest 对 Vue 3 的编译支持的不是很好，所以选择了 <code>cypress</code> 同时做单元测试和 E2E 测试。整个 <code>create-vue</code> 包的依赖数量非常少，很多没有必要的依赖都没放，而且胖茶自己做了一个预先打包导致下载速度变快了许多。同时创建的模板项目也足够轻量。</p>
<p>后面 antfu 还介绍了最近他开发的 <a href="https://github.com/unjs/unplugin" target="_blank" rel="noopener">unplugin</a>，支持一个插件写完，Rollup、Vite、Webpack 4、Webpack 5 都能使用，这个还没有详细使用过，下次有机会细看。</p>
<h2 id="create-vue-源码解析"><a class="markdownIt-Anchor" href="#create-vue-源码解析"></a> create-vue 源码解析</h2>
<p>首先看目录结构：</p>
<ul>
<li><code>index.js</code> 是整个 CLI 的打包入口，所有逻辑都是从这里开始的</li>
<li><code>utils</code> 包含了用到的一些工具函数</li>
<li><code>template</code> Vue 项目模板，例如默认的 default 模板、带 router 的模板、带 ts 支持的模板等等。</li>
<li><code>playground</code> 利用 create-vue 生成的项目的快照结果，在运行 <code>pnpm test</code> 时会用到，测试生成的模板项目代码的正确性</li>
</ul>
<p>非常简洁明了，好在项目处于刚开始的阶段，<code>index.js</code> 只有 300 多行，可以很容易了解其中的细节。</p>
<h3 id="整体流程"><a class="markdownIt-Anchor" href="#整体流程"></a> 整体流程</h3>
<ul>
<li>使用 <code>prompt</code> 询问用户一系列 Yes/No 的问题，看用户需要哪些 feature，包括 TS, JSX, router, vuex, cypress。同时也会询问包名和是否覆盖已经存在的文件夹（如果之前已经创建过内容的话）。</li>
<li>验证包名是否合法，将不合法包名转换成合法的。</li>
<li>写入带包名和版本号的 package.json</li>
<li>调用 <code>render</code> 函数，首先使用 <code>render('base')</code> 创建一个基础的模板，接下来按照用户需要哪些 feature，往已经创建的项目中添加对应的模板，例如 <code>render('config/jsx')</code> 就是对基础模板添加了 JSX 支持。</li>
<li>如果需要 TS 支持的话，后面有个特殊操作把所有 JS 重命名为 TS。将 <code>jsconfig.json</code> 重命名为 <code>tsconfig.json</code>。</li>
<li>默认是所有模板都包含测试的，如果用户不需要，最后需要删除一下</li>
<li>判断当前使用的包管理器是 <code>npm/yarn/pnpm</code>，方便后续输出 <code>xxx install</code> 提示</li>
<li>生成 <a href="http://README.md" target="_blank" rel="noopener">README.md</a></li>
<li>最后输出提示，提示用户生成成功并展示绿色（<code>kolorist</code> 这个包用来处理颜色）的提示消息，提示后续操作 <code>cd xxx</code>, <code>xxx install</code>, <code>xxx dev</code></li>
</ul>
<p>可以先运行一遍 <code>npm init vue@next</code> 感受一下具体的效果。</p>
<h3 id="具体分析"><a class="markdownIt-Anchor" href="#具体分析"></a> 具体分析</h3>
<p>可以看到，这里面最重要的还是 <code>render</code> 函数的实现，可以把一个相对目录下的文件给复制到最终生成的项目里面，同时还需要考虑文件相同的时候需要如何进行合并操作。这里主要看一下 <code>render</code> 函数的实现和一些我们以后可能用到的工具函数。</p>
<h4 id="支持-feature-flag"><a class="markdownIt-Anchor" href="#支持-feature-flag"></a> 支持 feature flag</h4>
<p>支持类似 <code>npm init vue@next --vuex --ts</code> 这种命令行参数，省去 <code>prompt</code> 提问环节直接开始生成项目。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> isFeatureFlagsUsed =</span><br><span class="line">    <span class="keyword">typeof</span> (argv.default || argv.ts || argv.jsx || argv.router || argv.vuex || argv.tests) ===</span><br><span class="line">    <span class="string">'boolean'</span></span><br><span class="line"></span><br><span class="line">prompt(</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#123;</span><br><span class="line">    name: <span class="string">'needsTypeScript'</span>,</span><br><span class="line">    <span class="comment">// 如果使用了 feature flag，直接 type 函数返回 null，就不会提问了</span></span><br><span class="line">    type: <span class="function"><span class="params">()</span> =&gt;</span> (isFeatureFlagsUsed ? <span class="literal">null</span> : <span class="string">'toggle'</span>),</span><br><span class="line">    message: <span class="string">'Add TypeScript?'</span>,</span><br><span class="line">    initial: <span class="literal">false</span>,</span><br><span class="line">    active: <span class="string">'Yes'</span>,</span><br><span class="line">    inactive: <span class="string">'No'</span></span><br><span class="line">&#125;,</span><br><span class="line">)</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<h4 id="render-函数"><a class="markdownIt-Anchor" href="#render-函数"></a> <code>render</code> 函数</h4>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 所有模板根目录位于 template 之下</span></span><br><span class="line"><span class="keyword">const</span> templateRoot = path.resolve(__dirname, <span class="string">'template'</span>)</span><br><span class="line"><span class="comment">// 传给一个模板名称，例如 `base`，对应于 template/base 这个模板</span></span><br><span class="line"><span class="keyword">const</span> render = <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">templateName</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 拿到真正的模板路径 templateDir 之后使用 renderTemplate 将 templateDir 下的内容尝试生成到 root 中，这里 root 就是之前用户输入指定的目标路径</span></span><br><span class="line">    <span class="keyword">const</span> templateDir = path.resolve(templateRoot, templateName)</span><br><span class="line">    renderTemplate(templateDir, root)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>template/base</code> 是一个最简单的所有结果都需要模板，它包括了 <code>.vscode</code>、<code>index.html</code>、<code>vite.config.js</code> 等这些基础性的东西。注意 vite 的理念和 Webpack 不一样，Webpack 和 esbuild 这些都是以 JS 为入口，但是 vite 是以 index.html 为入口的，使用的时候需要转换一下思维。这个模板的目录结构如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.</span><br><span class="line">├── _gitignore</span><br><span class="line">├── index.html</span><br><span class="line">├── package.json</span><br><span class="line">├── public</span><br><span class="line">│   └── favicon.ico</span><br><span class="line">└── vite.config.js</span><br></pre></td></tr></table></figure>
<p>注意里面有个 <code>_gitignore</code> 文件，使用 <code>_</code> 开头是个惯例，因为以 <code>.</code> 开头的都是配置文件，会影响一些 CLI 工具和编辑器的行为，所以为了避免影响而使用 <code>_</code>，真正 render 的过程中需要重命名成 <code>.</code> 开头</p>
<p>我们主要看 <code>renderTemplate</code> 这个函数，位于 <code>util/renderTemplate.js</code> 中。</p>
<p>函数签名注释可以看，就是一个复制过程，但是又不完全是直接的复制，需要有一些特殊操作要考虑：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// utils/renderTemplate.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Renders a template folder/file to the file system,</span></span><br><span class="line"><span class="comment"> * by recursively copying all files under the `src` directory,</span></span><br><span class="line"><span class="comment"> * with the following exception:</span></span><br><span class="line"><span class="comment"> *   - `_filename` should be renamed to `.filename`</span></span><br><span class="line"><span class="comment"> *   - Fields in `package.json` should be recursively merged</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;string&#125;</span> </span>src source filename to copy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;string&#125;</span> </span>dest destination filename of the copy operation</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">renderTemplate</span>(<span class="params">src, dest</span>) </span>&#123;</span><br></pre></td></tr></table></figure>
<p>如果发现传入的是 <code>src</code> 文件夹的话，递归调用 <code>renderTemplate</code> 处理文件夹下的每一个文件或者文件夹：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// utils/renderTemplate.js</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> stats = fs.statSync(src)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (stats.isDirectory()) &#123;</span><br><span class="line">    <span class="comment">// if it's a directory, render its subdirectories and files recusively</span></span><br><span class="line">    fs.mkdirSync(dest, &#123; <span class="attr">recursive</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> file <span class="keyword">of</span> fs.readdirSync(src)) &#123;</span><br><span class="line">      renderTemplate(path.resolve(src, file), path.resolve(dest, file))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>递归调用写好，下面就只需要考虑 <code>src</code> 是文件的情况了。</p>
<p>如果是 <code>package.json</code> 文件，并且目标路径已经存在，需要先 merge 两个 JSON 对象，然后将 dependencies, devDependencies, peerDependencies, optionalDependencies 这 4 个字段按照字母序从上到下排列好。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (filename === <span class="string">'package.json'</span> &amp;&amp; fs.existsSync(dest)) &#123;</span><br><span class="line">  <span class="comment">// merge instead of overwriting</span></span><br><span class="line">  <span class="keyword">const</span> existing = <span class="built_in">JSON</span>.parse(fs.readFileSync(dest))</span><br><span class="line">  <span class="keyword">const</span> newPackage = <span class="built_in">JSON</span>.parse(fs.readFileSync(src))</span><br><span class="line">  <span class="keyword">const</span> pkg = sortDependencies(deepMerge(existing, newPackage))</span><br><span class="line">  fs.writeFileSync(dest, <span class="built_in">JSON</span>.stringify(pkg, <span class="literal">null</span>, <span class="number">2</span>) + <span class="string">'\n'</span>)</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果文件以 <code>_</code> 开头，需要重命名成以 <code>.</code> 开头：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (filename.startsWith(<span class="string">'_'</span>)) &#123;</span><br><span class="line">  <span class="comment">// rename `_file` to `.file`</span></span><br><span class="line">  dest = path.resolve(path.dirname(dest), filename.replace(<span class="regexp">/^_/</span>, <span class="string">'.'</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="deepmerge-和-sortdependencies"><a class="markdownIt-Anchor" href="#deepmerge-和-sortdependencies"></a> <code>deepMerge</code> 和 <code>sortDependencies</code></h4>
<p>这里有两个比较有用的函数，<code>deepMerge</code> 用来 merge 两个 object，相信这个也是面试的时候常考的一个题目，具体的思路就是如果都是对象的话就继续递归，递归到原始类型的时候就可以直接赋值来实现赋值了，而数组的话直接用解构赋值来一个浅拷贝就行了。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> isObject = <span class="function">(<span class="params">val</span>) =&gt;</span> val &amp;&amp; <span class="keyword">typeof</span> val === <span class="string">'object'</span></span><br><span class="line"><span class="keyword">const</span> mergeArrayWithDedupe = <span class="function">(<span class="params">a, b</span>) =&gt;</span> <span class="built_in">Array</span>.from(<span class="keyword">new</span> <span class="built_in">Set</span>([...a, ...b]))</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Recursively merge the content of the new object to the existing one</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;Object&#125;</span> </span>target the existing object</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;Object&#125;</span> </span>obj the new object</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">deepMerge</span>(<span class="params">target, obj</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">of</span> <span class="built_in">Object</span>.keys(obj)) &#123;</span><br><span class="line">    <span class="keyword">const</span> oldVal = target[key]</span><br><span class="line">    <span class="keyword">const</span> newVal = obj[key]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(oldVal) &amp;&amp; <span class="built_in">Array</span>.isArray(newVal)) &#123;</span><br><span class="line">      <span class="comment">// key 字段对应的值都是 array，那么使用 destructuring 来 merge</span></span><br><span class="line">      target[key] = mergeArrayWithDedupe(oldVal, newVal)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isObject(oldVal) &amp;&amp; isObject(newVal)) &#123;</span><br><span class="line">      <span class="comment">// key 字段对应的值都是对象，那么递归调用</span></span><br><span class="line">      target[key] = deepMerge(oldVal, newVal)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      target[key] = newVal</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> target</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>sortDependencies</code> 是将对象按照 key 进行排序，<a href="https://stackoverflow.com/a/23202095/8242705" target="_blank" rel="noopener">ES6 标准要求 object 对字符串类型的 key 按照插入序排列，对整数类型的 key 按照升序排列</a>，因为依赖项都是 npm 包名，必然以字母开头，可以按照插入序保证其迭代的时候的顺序，从而使得解构赋值能够拿到正确的顺序。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">sortDependencies</span>(<span class="params">packageJson</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> sorted = &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> depTypes = [<span class="string">'dependencies'</span>, <span class="string">'devDependencies'</span>, <span class="string">'peerDependencies'</span>, <span class="string">'optionalDependencies'</span>]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> depType <span class="keyword">of</span> depTypes) &#123;</span><br><span class="line">    <span class="keyword">if</span> (packageJson[depType]) &#123;</span><br><span class="line">      sorted[depType] = &#123;&#125;</span><br><span class="line"></span><br><span class="line">      <span class="built_in">Object</span>.keys(packageJson[depType])</span><br><span class="line">        .sort()</span><br><span class="line">        .forEach(<span class="function">(<span class="params">name</span>) =&gt;</span> &#123;</span><br><span class="line">          sorted[depType][name] = packageJson[depType][name]</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    ...packageJson,</span><br><span class="line">    ...sorted</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="清除旧项目-rm-rf"><a class="markdownIt-Anchor" href="#清除旧项目-rm-rf"></a> 清除旧项目 <code>rm -rf</code></h4>
<p>之前经常遇到一个问题是 <code>fs.rmdirSync</code> 这个函数只能删除空文件夹，非空文件夹会报错，搜索 Stack Overflow 给的最高票答案是用 <a href="https://stackoverflow.com/a/16605300/8242705" target="_blank" rel="noopener">rimraf</a>，但是这里为了少引入包可以直接实现了递归删除文件的功能。用的是多叉树深搜中的后序遍历，因为需要先删除子文件和子文件夹，才能保证当前文件夹为空。实现如下：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// utils/directoryTraverse.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">postOrderDirectoryTraverse</span>(<span class="params">dir, dirCallback, fileCallback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> filename <span class="keyword">of</span> fs.readdirSync(dir)) &#123;</span><br><span class="line">    <span class="keyword">const</span> fullpath = path.resolve(dir, filename)</span><br><span class="line">    <span class="comment">// 如果是文件夹，递归</span></span><br><span class="line">    <span class="keyword">if</span> (fs.lstatSync(fullpath).isDirectory()) &#123;</span><br><span class="line">      postOrderDirectoryTraverse(fullpath, dirCallback, fileCallback)</span><br><span class="line">      <span class="comment">// 子文件和子文件夹都处理好了再来用 dirCallback 处理这个文件夹</span></span><br><span class="line">      dirCallback(fullpath)</span><br><span class="line">      <span class="keyword">continue</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果是文件，直接用 fileCallback 处理</span></span><br><span class="line">    fileCallback(fullpath)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">emptyDir</span>(<span class="params">dir</span>) </span>&#123;</span><br><span class="line">  postOrderDirectoryTraverse(</span><br><span class="line">    dir,</span><br><span class="line">    (dir) =&gt; fs.rmdirSync(dir),</span><br><span class="line">    (file) =&gt; fs.unlinkSync(file)</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个工具函数也非常有用，又省去了一个 <code>npm install</code>。</p>
<h2 id="测试"><a class="markdownIt-Anchor" href="#测试"></a> 测试</h2>
<p>写完代码需要进行测试保证正确性。<code>package.json</code> 中的测试脚本如下所示：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="string">"build"</span>: <span class="string">"esbuild --bundle index.js --format=cjs --platform=node --outfile=outfile.cjs"</span>,</span><br><span class="line"><span class="string">"snapshot"</span>: <span class="string">"node snapshot.js"</span>,</span><br><span class="line"><span class="string">"pretest"</span>: <span class="string">"run-s build snapshot"</span>,</span><br><span class="line"><span class="string">"test"</span>: <span class="string">"node test.js"</span>,</span><br></pre></td></tr></table></figure>
<p>可以看到，首先是 <code>pretest</code> 运行 <code>npm run build</code> 进行打包，然后运行 <code>npm run snapshot</code> 生成 snapshot，生成快照过程就是各个 feature flag 排列组合一下，调用 create-vue 生成所有的可能的 feature flag 组合的模板结果，结果存放在 <code>playground</code> 文件夹下。排列组合可以使用二进制枚举实现。代码如下：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> featureFlags = [<span class="string">'typescript'</span>, <span class="string">'jsx'</span>, <span class="string">'router'</span>, <span class="string">'vuex'</span>, <span class="string">'with-tests'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// The following code &amp; comments are generated by GitHub CoPilot.</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fullCombination</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> combinations = []</span><br><span class="line"></span><br><span class="line">  <span class="comment">// for an array of 5 elements, there are 2^5 - 1= 31 combinations</span></span><br><span class="line">  <span class="comment">// (excluding the empty combination)</span></span><br><span class="line">  <span class="comment">// equivalent to the following:</span></span><br><span class="line">  <span class="comment">// [0, 0, 0, 0, 1] ... [1, 1, 1, 1, 1]</span></span><br><span class="line">  <span class="comment">// We can represent the combinations as a binary number</span></span><br><span class="line">  <span class="comment">// where each digit represents a flag</span></span><br><span class="line">  <span class="comment">// and the number is the index of the flag</span></span><br><span class="line">  <span class="comment">// e.g.</span></span><br><span class="line">  <span class="comment">// [0, 0, 0, 0, 1] = 0b0001</span></span><br><span class="line">  <span class="comment">// [1, 1, 1, 1, 1] = 0b1111</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Note we need to exclude the empty comination in our case</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>; i &lt; <span class="number">1</span> &lt;&lt; arr.length; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> combination = []</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> j = <span class="number">0</span>; j &lt; arr.length; j++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (i &amp; (<span class="number">1</span> &lt;&lt; j)) &#123;</span><br><span class="line">        combination.push(arr[j])</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    combinations.push(combination)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> combinations</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> flagCombinations = fullCombination(featureFlags)</span><br><span class="line">flagCombinations.push([<span class="string">'default'</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> flags <span class="keyword">of</span> flagCombinations) &#123;</span><br><span class="line">  createProjectWithFeatureFlags(flags)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>之后再运行 <code>test.js</code>，就是对 <code>playground</code> 里面所有的项目依次运行 <code>test:unit:ci</code>（组件单元测试） 和 <code>test:e2e:ci</code>（E2E测试）了：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> playgroundDir = path.resolve(__dirname, <span class="string">'./playground/'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> projectName <span class="keyword">of</span> fs.readdirSync(playgroundDir)) &#123;</span><br><span class="line">  <span class="keyword">if</span> (projectName.endsWith(<span class="string">'with-tests'</span>)) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`Running unit tests in <span class="subst">$&#123;projectName&#125;</span>`</span>)</span><br><span class="line">    <span class="keyword">const</span> unitTestResult = spawnSync(<span class="string">'pnpm'</span>, [<span class="string">'test:unit:ci'</span>])</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`Running e2e tests in <span class="subst">$&#123;projectName&#125;</span>`</span>)</span><br><span class="line">    <span class="keyword">const</span> e2eTestResult = spawnSync(<span class="string">'pnpm'</span>, [<span class="string">'test:e2e:ci'</span>])</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h2>
<ul>
<li>看尤大的 talk 每次都有比较大的收获，有很多细小的问题都会解释的比较清晰，同时对 Vue 的未来规划能了解一些。</li>
<li>create-vue 代码简洁，依赖少，启动快，同时这次全面拥抱 vite 也将是非常好的，抛弃掉 Webpack 之后轻松了许多，开发体验提升了不少。create-vue 中有不少工具函数可以先记下来，下次需要用到的时候就不愁没处 copy 啦~
<ul>
<li>不过 create-vue 现在还没有给模板添加 eslint 配置，后续可能会加上</li>
</ul>
</li>
</ul>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">upupming</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://upupming.site/2021/10/11/create-vue-learning/">https://upupming.site/2021/10/11/create-vue-learning/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://upupming.site">upupming 的博客</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/frontend/">frontend</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2022/03/25/typescript-getting-started/"><i class="fa fa-chevron-left">  </i><span>我眼中的 TypeScript（入门级别介绍）</span></a></div><div class="next-post pull-right"><a href="/2021/08/29/co-analysis/"><span>co 源码分析、迭代器、生成器、async/wait 对比</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="vcomment"></div><script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = 'true' == true ? true : false;
var verify = 'false' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'wiHsGgANF4mLmK2Hiubzew03-gzGzoHsz',
  appKey:'Tk0WjoOhLD8ppTfyhdCbyeDT',
  placeholder:'Just go go',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10',
  lang: 'zh-cn'
})</script></div></div><footer class="footer-bg" style="background-image: url(/img/background.png)"><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2024 By upupming</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script src="/js/search/algolia.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css"><script src="/js/katex.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="algolia-search"><div class="search-dialog__title" id="algolia-search-title">Algolia</div><div id="algolia-input-panel"><div id="algolia-search-input"></div></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>