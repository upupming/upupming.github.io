<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Speedy SSR åŠŸèƒ½çš„å®ç°åŸç†å’Œç»éªŒæ€»ç»“"><meta name="keywords" content="frontend"><meta name="author" content="upupming"><meta name="copyright" content="upupming"><title>Speedy SSR åŠŸèƒ½çš„å®ç°åŸç†å’Œç»éªŒæ€»ç»“ | upupming çš„åšå®¢</title><link rel="shortcut icon" href="/my-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css?version=1.6.1"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css?version=1.6.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.js" defer></script><link rel="manifest" href="/manifest.json"><link rel="manifest" href="/manifest.json"><meta name="theme-color" content="#1B9EF3"><meta name="msapplication-TileColor" content="#1B9EF3"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#1B9EF3"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: 'ca-pub-2188191456032650',
  enable_page_level_ads: 'true'
});
</script><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?295ad5c5a196e4964e20f74260711177";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><link rel="dns-prefetch" href="https://www.google-analytics.com"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-114899088-1', 'auto');
ga('send', 'pageview');</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"5WEDOKLFCL","apiKey":"26a57bfa5275b7c98a3b3ab7dae61915","indexName":"upupming-blog","hits":{"per_page":10},"languages":{"input_placeholder":"æœç´¢æ–‡ç« ","hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹:${query}","hits_stats":"æ‰¾åˆ° ${hits} æ¡ç»“æœï¼Œç”¨æ—¶ ${time} æ¯«ç§’"}},
  localSearch: undefined,
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="åˆ‡æ¢æ–‡ç« è¯¦æƒ…">åˆ‡æ¢ç«™ç‚¹æ¦‚è§ˆ</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">ç›®å½•</div><div class="sidebar-toc__progress"><span class="progress-notice">ä½ å·²ç»è¯»äº†</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#ä»€ä¹ˆæ˜¯æœåŠ¡ç«¯æ¸²æŸ“"><span class="toc-number">1.</span> <span class="toc-text"> ä»€ä¹ˆæ˜¯æœåŠ¡ç«¯æ¸²æŸ“</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#speedy-ä¸­æœåŠ¡ç«¯æ¸²æŸ“çš„å®ç°"><span class="toc-number">2.</span> <span class="toc-text"> Speedy ä¸­æœåŠ¡ç«¯æ¸²æŸ“çš„å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#bundler-å®ç°"><span class="toc-number">2.1.</span> <span class="toc-text"> Bundler å®ç°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#server-å®ç°"><span class="toc-number">2.2.</span> <span class="toc-text"> Server å®ç°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#adapter-å®ç°"><span class="toc-number">2.3.</span> <span class="toc-text"> Adapter å®ç°</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#æ€»ç»“ä¸æ€è€ƒ"><span class="toc-number">3.</span> <span class="toc-text"> æ€»ç»“ä¸æ€è€ƒ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#å‚è€ƒèµ„æ–™"><span class="toc-number">4.</span> <span class="toc-text"> å‚è€ƒèµ„æ–™</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/doraemon.jpeg"></div><div class="author-info__name text-center">upupming</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">æ–‡ç« </span><span class="pull-right">52</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">æ ‡ç­¾</span><span class="pull-right">44</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">åˆ†ç±»</span><span class="pull-right">27</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">å‹æƒ…é“¾æ¥</div><a class="author-info-links__name text-center" href="https://molunerfinn.com/">MARKSZã®Blog</a><a class="author-info-links__name text-center" href="https://github.com/ryanhanwu/How-To-Ask-Questions-The-Smart-Way/blob/master/README-zh_CN.md">æé—®çš„æ™ºæ…§</a><a class="author-info-links__name text-center" href="https://zh.wikipedia.org/">ä¸­æ–‡ç»´åŸºç™¾ç§‘</a><a class="author-info-links__name text-center" href="https://zbqtesla.github.io">ZBQTeslaçš„åšå®¢</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/img/background.png)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">upupming çš„åšå®¢</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">ä¸»é¡µ</a><a class="site-page" href="/archives">å½’æ¡£</a><a class="site-page" href="/tags">æ ‡ç­¾</a><a class="site-page" href="/categories">åˆ†ç±»</a><a class="site-page" href="https://mirror.upupming.site">Mirror</a><a class="site-page" href="https://music.wxhbts.com">éŸ³ä¹</a><a class="site-page" href="https://writing.upupming.site">Writing</a><a class="site-page" href="/about">å…³äº</a><a class="site-page" href="/rss">RSS</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> æœç´¢</span></a></span></div><div id="post-info"><div id="post-title">Speedy SSR åŠŸèƒ½çš„å®ç°åŸç†å’Œç»éªŒæ€»ç»“</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2023-05-21</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/å‰ç«¯/">å‰ç«¯</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/å‰ç«¯/åŸºç¡€çŸ¥è¯†/">åŸºç¡€çŸ¥è¯†</a><div class="post-meta-wordcount"><span>å­—æ•°æ€»è®¡: </span><span class="word-count">5.2k</span><span class="post-meta__separator">|</span><span>é˜…è¯»æ—¶é•¿: 24 åˆ†é’Ÿ</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><!--
æ˜¯ä¸ªå•¥
æœ‰å•¥ç”¨
æŠ€æœ¯éš¾ç‚¹
è¶‹åŠ¿
 -->
<p>åœ¨ 2022 å¹´ï¼Œå­—èŠ‚å®ä¹ çš„é‚£æ®µæ—¶é—´é‡Œï¼Œæˆ‘å‚ä¸äº† Speedy çš„å¼€å‘ï¼Œä¸»è¦çš„ä»»åŠ¡æ˜¯ä¸º Speedy å®ç°æœåŠ¡ç«¯æ¸²æŸ“çš„èƒ½åŠ›ï¼Œæœ¬æ–‡ä»‹ç»ä¸€ä¸‹å®ç°åŸç†ã€‚</p>
<p><img src="https://s2.loli.net/2023/05/21/h6rf7PRjOlKEZHA.png" alt="20230521221623"></p>
<a id="more"></a>
<h2 id="ä»€ä¹ˆæ˜¯æœåŠ¡ç«¯æ¸²æŸ“"><a class="markdownIt-Anchor" href="#ä»€ä¹ˆæ˜¯æœåŠ¡ç«¯æ¸²æŸ“"></a> ä»€ä¹ˆæ˜¯æœåŠ¡ç«¯æ¸²æŸ“</h2>
<p>æœåŠ¡ç«¯æ¸²æŸ“ï¼ˆServer Side Rendering, SSRï¼‰ï¼Œå°±æ˜¯æŒ‡ä»æœåŠ¡ç«¯æ¸²æŸ“å‡ºå‰ç«¯é¡µé¢çš„å†…å®¹ã€‚åœ¨ä»¥å¾€æ—©æœŸçš„æ—¶å€™ï¼Œå‰åç«¯è¿˜æ²¡æœ‰åˆ†ç¦»ï¼Œç½‘é¡µå†…å®¹å®Œå…¨æ˜¯ç”±æœåŠ¡ç«¯æ¸²æŸ“çš„ï¼Œä¾‹å¦‚ç”¨ PHP åšåç«¯ç”Ÿæˆå¥½ç½‘é¡µå†…å®¹ä¹‹åè¿”å›ç»™å‰ç«¯è´Ÿè´£æ˜¾ç¤ºï¼Œæˆ‘äº†è§£åˆ°è¿˜æœ‰ JSP (Java Server Pages), <a href="http://ASP.NET" target="_blank" rel="noopener">ASP.NET</a> (Active Server Pages Network Enabled Technologies) ç­‰ã€‚ä½†æ˜¯éšç€å‰ç«¯è¶Šæ¥è¶Šå¤æ‚ï¼Œå‰åç«¯å¼€å§‹åˆ†ç¦»ï¼Œé€æ¸å‡ºç°äº†å„ç§å‰ç«¯æ¡†æ¶ï¼Œå¦‚ React (2013), Vue (2014), Angular (2016), Svelte (2016) ç­‰ç­‰ã€‚å‰åç«¯å¼€å§‹åˆ†å·¥æ˜ç¡®ï¼Œå®¢æˆ·ç«¯æ¸²æŸ“ï¼ˆClient Side Rendering, CSRï¼‰å¤§è¡Œå…¶é“ï¼Œè¿™ç§æ¨¡å¼ä¸‹é¢æ‰€æœ‰é¡µé¢å†…å®¹éƒ½ç”±å®¢æˆ·ç«¯åŠ¨æ€æ¸²æŸ“è€Œæ¥ã€‚</p>
<p>çº¯çš„å®¢æˆ·ç«¯æ¸²æŸ“ä¸»è¦æœ‰ä¸¤ä¸ªé—®é¢˜:</p>
<ol>
<li>æ‹¿åˆ°å‰ç«¯é¡µé¢ä»£ç ä¹‹åï¼Œä¸€èˆ¬é¡µé¢å¾€å¾€éœ€è¦ä»åç«¯è·å–æ•°æ®æ‰èƒ½å±•ç¤ºé¡µé¢ï¼Œå¯¼è‡´ç™½å±æ—¶é—´é•¿ã€‚</li>
<li>SEO ä¸å‹å¥½ï¼Œæœç´¢å¼•æ“æ‹¿åˆ°é¡µé¢ä¹‹åå¾€å¾€ä¸ä¼šç»§ç»­è¯·æ±‚æ•°æ®ï¼Œè¿™æ ·æŠ“å–åˆ°çš„é¡µé¢å¯èƒ½ä¼šæ˜¯åªå¸¦ JS æ–‡ä»¶çš„ç©ºç™½ HTMLã€‚</li>
</ol>
<p>è¿™æ · SSR åˆé€æ¸æµè¡Œèµ·æ¥ï¼Œä»¥å¼¥è¡¥ CSR çš„ç¼ºç‚¹ã€‚SSR ä¸»è¦çš„æ–¹æ³•æ˜¯å‰ç«¯æ¡†æ¶å®ç°ä¸€å¥—æœåŠ¡ç«¯æ¸²æŸ“çš„ APIï¼Œæ”¯æŒå¯¹ç»„ä»¶è¿›è¡Œè„±æ°´ï¼ˆhydrateï¼‰å’Œæ°´åˆï¼ˆde-hydrateï¼‰ã€‚æœåŠ¡ç«¯ï¼ˆNode.jsï¼‰è´Ÿè´£å°†å‰ç«¯ç»„ä»¶è¿›è¡Œè„±æ°´å¾—åˆ° HTML å†…å®¹ï¼Œè¿™æ ·æµè§ˆå™¨è¯·æ±‚ä¹‹åçš„é¡µé¢æ˜¯æœ‰å†…å®¹çš„ï¼Œä¸ç”¨å†é‡å¤è¯·æ±‚æ•°æ®ï¼›æµè§ˆå™¨æ‹¿åˆ°æ•°æ®å’Œ HTML ä¹‹åè¿›è¡Œæ°´åˆï¼Œç»§ç»­ä»¥å‰ç«¯ç»„ä»¶çš„å½¢å¼å®Œæˆæ¸²æŸ“ï¼Œæ”¯æŒå‰ç«¯ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸå’Œå¯¹åº”çš„ APIã€‚è¿™æ · CSR å’Œ SSR çš„ä¼˜ç‚¹å°±ç»“åˆäº†èµ·æ¥ï¼Œä½¿å¾—å¼€å‘ä½“éªŒæ›´å¥½çš„åŒæ—¶é¦–å±å¾—ä»¥ä¿è¯ï¼Œå½“ç„¶éœ€è¦ç»´æŠ¤é¢å¤–çš„ Node.js æœåŠ¡å™¨ï¼Œä»¥åŠæ„å»ºå·¥å…·éœ€è¦å¯¹æœåŠ¡ç«¯æ¸²æŸ“åšä¸€äº›æ”¯æŒï¼Œè¿™æ˜¯é¢å¤–çš„æˆæœ¬æŠ•å…¥ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘è¿™æ¬¡è¦è®²çš„å†…å®¹~</p>
<h2 id="speedy-ä¸­æœåŠ¡ç«¯æ¸²æŸ“çš„å®ç°"><a class="markdownIt-Anchor" href="#speedy-ä¸­æœåŠ¡ç«¯æ¸²æŸ“çš„å®ç°"></a> Speedy ä¸­æœåŠ¡ç«¯æ¸²æŸ“çš„å®ç°</h2>
<p><a href="https://github.com/upupming/speedy-ssr-examples" target="_blank" rel="noopener">https://github.com/upupming/speedy-ssr-examples</a> ç»™å‡ºäº† Speedy çš„ SSR çš„ä¸€äº› DEMOã€‚ä»¥ <a href="https://github.com/upupming/speedy-ssr-examples/tree/main/examples/basic" target="_blank" rel="noopener"><code>basic</code></a> é¡¹ç›®ä¸ºä¾‹ï¼Œåœ¨ <code>speedy.config.ts</code> ä¸­å®šä¹‰äº†å››ä¸ªè·¯ç”±ï¼Œåˆ†åˆ«è§£é‡Šå¦‚ä¸‹:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  ssr: &#123;</span><br><span class="line">    pages: [</span><br><span class="line">      <span class="comment">// SSG è·¯ç”±</span></span><br><span class="line">      &#123;</span><br><span class="line">        path: <span class="string">'/ssg'</span>,</span><br><span class="line">        name: <span class="string">'ssg'</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// SSR è·¯ç”±</span></span><br><span class="line">      &#123;</span><br><span class="line">        path: <span class="string">'/ssr'</span>,</span><br><span class="line">        name: <span class="string">'ssr'</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// æ²¡æœ‰æœåŠ¡ç«¯æ¸²æŸ“çš„çº¯é™æ€é¡µé¢</span></span><br><span class="line">      &#123;</span><br><span class="line">        path: <span class="string">'/static'</span>,</span><br><span class="line">        name: <span class="string">'static'</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// æ”¯æŒå‚æ•°çš„é¡µé¢</span></span><br><span class="line">      &#123;</span><br><span class="line">        path: <span class="string">'/params/:id/:name'</span>,</span><br><span class="line">        name: <span class="string">'params'</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œ <code>name</code> å°±æ˜¯ä»£ç æ‰€å¤„çš„æ–‡ä»¶å¤¹ï¼Œ<code>path</code> æ˜¯æœ€ç»ˆäº§ç‰©çš„ URL è·¯å¾„ã€‚æ¯ä¸€ä¸ªé¡µé¢çš„ç»„ç»‡å½¢å¼éƒ½æ˜¯æ–‡ä»¶å¤¹åŒ…å«ä¸¤ä¸ªæ–‡ä»¶ <code>index.tsx</code> å’Œ <code>prefetch.ts</code> å½¢å¼ï¼Œå…¶ä¸­ <code>index.tsx</code> æ˜¯é¡µé¢ç»„ä»¶ï¼Œ<code>prefetch</code> æ˜¯æ•°æ®é¢„å–å‡½æ•°ã€‚æˆ‘ä»¬å€Ÿé‰´äº† Next.js çš„æ€è·¯ï¼Œæ ¹æ® <code>prefetch</code> ä¸­å¯¼å‡ºçš„å‡½æ•°åç¡®å®šå½“å‰é¡µé¢æ˜¯ SSR è¿˜æ˜¯ SSG (Server Side Generating, æœåŠ¡ç«¯ç”Ÿæˆ)ã€‚ä¸ SSR ä¸åŒï¼ŒSSG åªåœ¨æ„å»ºçš„æ—¶å€™ç”Ÿæˆä¸€æ¬¡æ•°æ®ï¼Œç„¶ååœ¨å‰ç«¯è®¿é—®æ—¶æ¯æ¬¡éƒ½è·å–æ„å»ºæ—¶çš„æ•°æ®ï¼Œè¿™ç§æ¯”è¾ƒé€‚ç”¨äºæ„å»ºæ—¶å†…å®¹å°±ç¡®å®šäº†çš„é¡µé¢ï¼Œä¾‹å¦‚ä¸ªäººåšå®¢ã€‚</p>
<p><code>prefetch</code> ä¸­çš„æ•°æ®ä¼šä½œä¸º <code>props</code> å–‚ç»™ <code>index.tsx</code> ä¸­çš„ç»„ä»¶ï¼Œç„¶åæ¸²æŸ“æˆå½“å‰é¡µé¢ï¼Œä¸»è¦ç”¨æ¥è§£å†³é¦–å±æ•°æ®è¯·æ±‚è€—æ—¶é€ æˆç™½å±çš„é—®é¢˜ï¼Œè¦æ±‚å¯¼å‡ºçš„å‡½æ•°åç§°å¿…é¡»ä¸º <code>getStaticProps</code> æˆ–è€… <code>getServerSideProps</code>ï¼Œå‰è€…æ˜¯ SSGï¼Œåè€…æ˜¯ SSRã€‚</p>
<p>ä»¥ <code>/ssr</code> é¡µé¢ä¸ºä¾‹ï¼Œåç«¯ä¼šç›´æ¥è¿”å›å¸¦å†…å®¹çš„ HTMLï¼Œå¹¶ä¸”å°† <code>prefetch</code> ä¸­é¢„å–åˆ°çš„æ•°æ®æŒ‚åœ¨å…¨å±€å˜é‡ <code>__CONTEXT__.routeData</code> ä¹‹ä¸‹ï¼Œä»¥ä¾›å‰ç«¯ç»§ç»­æ°´åˆï¼Œå°† HTML å˜æˆç»‘å®šäº†äº‹ä»¶å’Œç”Ÿå‘½å‘¨æœŸçš„ React ç»„ä»¶ã€‚</p>
<p><img src="https://s2.loli.net/2023/05/21/a4HzbSqZ1K7VoBx.png" alt="20230521194101"><br>
<img src="https://s2.loli.net/2023/05/21/7UlhG8MIa9PzZ1T.png" alt="20230521194138"></p>
<p>æˆ‘ä»¬ä½¿ç”¨ <code>@speedy-js/universal</code> åŒ…æ¥æ”¯æŒ SSRï¼Œå…¶å°è£…äº† <code>@speedy-js/core</code>ï¼Œåœ¨å…¶åŸºç¡€ä¸Šå¢åŠ äº† SSR å’Œ SSG çš„èƒ½åŠ›ã€‚<code>@speedy-js/universal</code> çš„ä¸»è¦è´¡çŒ®æœ‰:</p>
<ul>
<li>å®ç°äº†ä¸€ä¸ª <code>BaseBundler</code> ç±»ï¼ŒåŒ…å« <code>serverBundler</code> å’Œ <code>clientBundler</code>ã€‚å®ç°äº† <code>ReactBundler</code> æ¥å®ç°å¯¹ React æ¡†æ¶ä»£ç çš„ç¼–è¯‘ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡é…ç½® <code>ssr.framework</code> æ¥é…ç½®å½“å‰ä½¿ç”¨çš„æ¡†æ¶ã€‚
<ul>
<li>åœ¨ Speedy ä¸­å­˜åœ¨å­ç¼–è¯‘å™¨çš„æ¦‚å¿µï¼Œä¹Ÿæ˜¯å€Ÿé‰´äº Webpackï¼Œæˆ‘ä»¬é€šè¿‡å°† <code>serverBundler</code> ä½œä¸º <code>clientBundler</code> çš„å­ç¼–è¯‘å™¨ï¼Œè¿™æ ·åœ¨å¼€å‘æ¨¡å¼ä¸‹åªæœ‰ä¸€ä¸ª watcherï¼Œä»£ç å‘ç”Ÿä¿®æ”¹æ—¶ï¼Œ<code>clientBundler</code> ä¼šé€šçŸ¥ <code>serverBundler</code>ã€‚</li>
<li><code>serverBundler</code> è´Ÿè´£ç¼–è¯‘æœåŠ¡ç«¯ä»£ç ï¼Œäº§ç‰©æ˜¯ CJS æ ¼å¼ã€‚ç¼–è¯‘äº§ç‰©ä»£ç å­˜åœ¨ä¸¤ä¸ªå¯¼å‡ºå‡½æ•°ï¼Œåˆ†åˆ«æ˜¯ <code>Component</code> å’Œ <code>getServerSideProps</code>ï¼Œå…¶ä¸­ <code>Component</code> æ˜¯æœåŠ¡ç«¯ä»£ç çš„ React ç»„ä»¶ï¼Œ<code>getServerSideProps</code> æ˜¯å¯¹åº”çš„ <code>prefetch.ts</code> ä¸­çš„æ•°æ®é¢„å–å‡½æ•°ã€‚
<ul>
<li>è„±æ°´é€»è¾‘å·²ç»å°è£…åœ¨ bundler å†…éƒ¨ï¼Œåé¢çš„ Server ä¼šè´Ÿè´£å°† <code>Component</code> è„±æ°´å¹¶å¤„ç†å‰ç«¯è¯·æ±‚ã€‚</li>
</ul>
</li>
<li><code>clientBundler</code> è´Ÿè´£ç¼–è¯‘å®¢æˆ·ç«¯ä»£ç ï¼Œäº§ç‰©æ˜¯ SystemJS æ ¼å¼ï¼ˆåˆ©ç”¨ SystemJS æ”¯æŒåˆ†åŒ…ï¼‰ã€‚åŒæ ·åŒ…å«ä¸¤ä¸ªå¯¼å‡ºï¼Œåˆ†åˆ«æ˜¯ <code>default</code> å’Œ <code>getServerSideProps</code>ã€‚<code>default</code> æ˜¯å®¢æˆ·ç«¯ä»£ç çš„ React ç»„ä»¶ï¼Œ<code>getServerSideProps</code> æ˜¯å¯¹åº”çš„ <code>prefetch.ts</code> ä¸­çš„æ•°æ®é¢„å–å‡½æ•°ã€‚<code>getServerSideProps</code> åœ¨å®¢æˆ·ç«¯ä»£ç ä¸­ä»ç„¶å­˜åœ¨æ˜¯ä¸ºäº†è¿›è¡Œ CSR é™çº§ï¼Œåœ¨æœåŠ¡ç«¯æŒ‚æ‰æ—¶ä»ç„¶èƒ½å¤Ÿè¿›è¡Œæ•°æ®è¯·æ±‚ã€‚
<ul>
<li>åªé è¿™ä¸¤ä¸ªå¯¼å‡ºï¼Œæ— æ³•é¡µé¢æ­£å¸¸è¿è¡Œï¼Œå› æ­¤æˆ‘ä»¬çš„ Server è¿˜ä¼šå¢åŠ  JS æ–‡ä»¶ï¼Œåˆ©ç”¨è¿™ä¸¤ä¸ªå¯¼å‡ºï¼Œåœ¨å¯¹åº”çš„æ—¶æœºè¿›è¡Œæ°´åˆï¼Œä½¿é¡µé¢æ­£å¸¸å·¥ä½œã€‚</li>
</ul>
</li>
</ul>
</li>
<li>å®ç°äº†ä¸€ä¸ª <code>BaseServer</code> ç±»ï¼Œå¯ä»¥é€šè¿‡ <code>createServer</code> å‡½æ•°æ¥åˆ›å»ºå…¶å­ç±» <code>DevServer</code>ï¼ˆåŠŸèƒ½ç±»ä¼¼ <code>vite dev</code>ï¼‰ æˆ–è€… <code>ProdServer</code>ï¼ˆåŠŸèƒ½ç±»ä¼¼ <code>vite preview</code>ï¼‰,å…¶è¿”å›ç»“æœç±»ä¼¼äº <a href="https://github.com/vercel/next.js/blob/cfa8ab9cbfb8818408654e223aa9253be619879e/packages/next/server/next.ts#L25" target="_blank" rel="noopener">NextServer</a>, ä½¿ç”¨ä¾‹å­å‚è€ƒ <a href="https://nextjs.org/docs/advanced-features/custom-server" target="_blank" rel="noopener">Next.js | Custom Server</a>ã€‚å¹¶ä¸”ä¸ä¹‹å¯¹åº”æœ‰ä¸€ä¸ª <code>createHttpServer</code> å‡½æ•°æ¥åˆ›å»º Server çš„åŒæ—¶ç»‘å®šåˆ°ç«¯å£è®©å‰ç«¯ç›´æ¥è®¿é—®ã€‚
<ul>
<li>é‡‡ç”¨äº† Connect ä¸­é—´ä»¶å®ç°å†…éƒ¨çš„è¯·æ±‚å¤„ç†é€»è¾‘ï¼Œæ–¹ä¾¿æ‹“å±•å’Œå¤ç”¨ã€‚</li>
</ul>
</li>
<li>æ”¯æŒäº†ä¸åŒçš„ Adapterï¼Œæ¥å®ç°å°†äº§ç‰©éƒ¨ç½²åˆ°ä¸åŒçš„ Serverless ç¯å¢ƒã€‚æ”¯æŒäº† Vercel å’Œ Cloudflare Workerã€‚</li>
</ul>
<h3 id="bundler-å®ç°"><a class="markdownIt-Anchor" href="#bundler-å®ç°"></a> Bundler å®ç°</h3>
<p><code>BaseBundler</code> åŒ…å«ä¸€äº›é€šç”¨é€»è¾‘ï¼Œå…·ä½“ä¸åŒæ¡†æ¶çš„å®ç°ç”±å¯¹åº”çš„å­ç±»å»å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥æŠ½è±¡å‡ºä¸€äº› Bundler éœ€è¦åšçš„äº‹æƒ…ï¼š</p>
<ul>
<li>åŒ…å« <code>clientBundler</code> å’Œ <code>serverBundler</code> åˆ†åˆ«ç¼–è¯‘å®¢æˆ·ç«¯ä»£ç å’ŒæœåŠ¡ç«¯ä»£ç ã€‚</li>
<li>åœ¨æ„å»ºæ—¶è¿›è¡Œ SSG ç”Ÿæˆï¼Œè°ƒç”¨å¯¹åº”è¯­è¨€çš„ <code>SSGRunner</code> æ¥ç”Ÿæˆ JSON æ•°æ®åˆ°äº§ç‰©ä¸­ã€‚</li>
</ul>
<p><code>ReactBundler</code> åŒ…å«å…·ä½“çš„å®ç°ï¼Œä¸‹é¢æ˜¯åˆå§‹åŒ– <code>clientBundler</code> å’Œ <code>serverBundler</code> çš„é€»è¾‘ï¼š</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">this</span>.clientBundler = <span class="keyword">await</span> SpeedyBundler.create(</span><br><span class="line">  &#123;</span><br><span class="line">    ...config,</span><br><span class="line">    target: <span class="string">'es6'</span>,</span><br><span class="line">    root,</span><br><span class="line">    mode: dev ? <span class="string">'development'</span> : <span class="string">'production'</span>,</span><br><span class="line">    input: &#123;</span><br><span class="line">      <span class="comment">// Client-side-only entries</span></span><br><span class="line">      ...config?.input,</span><br><span class="line">      <span class="comment">// SSR client entriesï¼Œæˆ‘ä»¬å¯¹æ¯ä¸ªé¡µé¢éƒ½ç”Ÿæˆäº†ä¸€ä¸ªè™šæ‹Ÿå…¥å£æ–‡ä»¶ï¼Œè¿™æ ·èƒ½å¤Ÿå¯¹ç”¨æˆ·ç¼–å†™çš„æ–‡ä»¶è¿›è¡Œ importï¼Œåœ¨ç”¨æˆ·ä»£ç çš„åŸºç¡€ä¸Šåšä¸€äº›å°è£…ï¼›virtual entry çš„æ€è·¯åœ¨æ„å»ºå·¥å…·ä¸­å¾ˆå¸¸è§</span></span><br><span class="line">      ...Object.fromEntries(appContext.normalizedPages.map(<span class="function">(<span class="params">&#123; name &#125;</span>) =&gt;</span> [name, getVirtualEntry(name)])),</span><br><span class="line">      <span class="comment">// virtual entryï¼Œè¿™é‡Œçš„è™šæ‹Ÿå…¥å£çš„ä»£ç ä¹Ÿå°±æ˜¯é©±åŠ¨å®¢æˆ·ç«¯ä»£ç è¿›è¡Œæ°´åˆçš„é‚£éƒ¨åˆ†æ¨¡æ¿ä»£ç </span></span><br><span class="line">      <span class="comment">// VIRTUAL_ROOT_NAME === '__ROOT__'</span></span><br><span class="line">      [VIRTUAL_ROOT_NAME]: getVirtualEntry(VIRTUAL_ROOT_NAME),</span><br><span class="line">    &#125;,</span><br><span class="line">    output: &#123;</span><br><span class="line">      format: <span class="string">'system'</span>,</span><br><span class="line">      splitting: <span class="literal">true</span>,</span><br><span class="line">      ...config?.output,</span><br><span class="line">      path: OUTPUT_FOLDER,</span><br><span class="line">      entryNames: dev ? <span class="string">'client/[name]'</span> : <span class="string">'client/[name]-[hash]'</span>,</span><br><span class="line">      chunkNames: <span class="string">'client/[name].[hash]'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    define: &#123;</span><br><span class="line">      __BROWSER__: <span class="string">'true'</span>,</span><br><span class="line">      global: <span class="string">'globalThis'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    command: dev ? <span class="string">'serve'</span> : <span class="string">'build'</span>,</span><br><span class="line">    watch: dev,</span><br><span class="line">    configFile: <span class="literal">false</span>,</span><br><span class="line">    platform: <span class="string">'browser'</span>,</span><br><span class="line">    plugins: [</span><br><span class="line">      ...(config?.plugins ?? []),</span><br><span class="line">      resolvePlugin(&#123; root &#125;),</span><br><span class="line">      <span class="comment">// clientPlugin é‡Œé¢åŒ…å«äº†å¯¹ virtual entry çš„å¤„ç†é€»è¾‘å’Œå¯¹åº”åº”è¯¥ç”Ÿæˆçš„ä»£ç ã€‚</span></span><br><span class="line">      clientPlugin(&#123;</span><br><span class="line">        appContext: <span class="keyword">this</span>.appContext,</span><br><span class="line">      &#125;),</span><br><span class="line">      <span class="comment">// è¿›åº¦æ¡æ’ä»¶ï¼Œå¹¶è¡Œå±•ç¤º Client ä»£ç çš„è¿›åº¦æ¡</span></span><br><span class="line">      progressPlugin(&#123; id: <span class="string">'Client'</span>, quietOnDev: <span class="literal">false</span> &#125;),</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">'universal.client'</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> serverPlatform = environment === <span class="string">'node'</span> ? <span class="string">'node'</span> : <span class="string">'browser'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>.serverBundler = <span class="keyword">await</span> <span class="keyword">this</span>.clientBundler.createChildCompiler(</span><br><span class="line">  &#123;</span><br><span class="line">    ...config,</span><br><span class="line">    root,</span><br><span class="line">    input: <span class="built_in">Object</span>.fromEntries(appContext.normalizedPages.map(<span class="function">(<span class="params">&#123; name &#125;</span>) =&gt;</span> [name, getVirtualEntry(name)])),</span><br><span class="line">    output: &#123;</span><br><span class="line">      splitting: <span class="literal">true</span>,</span><br><span class="line">      ...config?.output,</span><br><span class="line">      format: <span class="string">'cjs'</span>,</span><br><span class="line">      path: OUTPUT_FOLDER,</span><br><span class="line">      entryNames: <span class="string">'server/[name]'</span>,</span><br><span class="line">      chunkNames: <span class="string">'server/[name].[hash]'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    html: <span class="literal">false</span>,</span><br><span class="line">    mode: dev ? <span class="string">'development'</span> : <span class="string">'production'</span>,</span><br><span class="line">    minify: <span class="literal">false</span>,</span><br><span class="line">    command: <span class="string">'build'</span>,</span><br><span class="line">    watch: dev,</span><br><span class="line">    configFile: <span class="literal">false</span>,</span><br><span class="line">    define: &#123;</span><br><span class="line">      __BROWSER__: <span class="string">'false'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    platform: serverPlatform,</span><br><span class="line">    plugins: [</span><br><span class="line">      ...(config?.plugins ?? []),</span><br><span class="line">      resolvePlugin(&#123; root, external: <span class="literal">true</span> &#125;),</span><br><span class="line">      externalPlugin(externalOptions),</span><br><span class="line">      <span class="comment">// serverPlugin é‡Œé¢åŒ…å«äº†å¯¹ virtual entry çš„å¤„ç†é€»è¾‘å’Œå¯¹åº”åº”è¯¥ç”Ÿæˆçš„ä»£ç ã€‚</span></span><br><span class="line">      serverPlugin(&#123; root, appContext &#125;),</span><br><span class="line">      <span class="comment">// è¿›åº¦æ¡æ’ä»¶ï¼Œå¹¶è¡Œå±•ç¤º Server ä»£ç çš„è¿›åº¦æ¡</span></span><br><span class="line">      progressPlugin(&#123; id: <span class="string">'Server'</span>, quietOnDev: <span class="literal">false</span> &#125;),</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">'universal.server'</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæœ€æ ¸å¿ƒçš„æ˜¯å¯¹ç”Ÿæˆäº§ç‰©çš„ä»£ç çš„æ§åˆ¶ï¼Œå…¶å®ç°é€»è¾‘åœ¨ <code>clientPlugin</code> ä¸­ã€‚Speedy ä¸­æ’ä»¶å‡æ˜¯é€šè¿‡ Tapable çš„ hook æ¥å®ç°äº†ï¼Œä¹Ÿæ˜¯å€Ÿé‰´äº† Webpack çš„æ’ä»¶ä½“ç³»ã€‚æˆ‘ä»¬æ¥çœ‹ <code>clientPlugin</code> ä¸­æ¯”è¾ƒæ ¸å¿ƒçš„ä»£ç ç”Ÿæˆé€»è¾‘ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// packages/universal/src/bundler/react/plugins/virtual-entry/client.tsx</span><br><span class="line">import React from &apos;react&apos;;</span><br><span class="line">import ReactDOM from &apos;react-dom&apos;;</span><br><span class="line">import &#123; Browser, loadRouteModules &#125; from &apos;@speedy-js/universal/components&apos;;</span><br><span class="line"></span><br><span class="line">async function init() &#123;</span><br><span class="line">  const data = JSON.parse(document.getElementById(&apos;__SPEEDY_DATA__&apos;)?.textContent ?? &apos;&#123;&#125;&apos;);</span><br><span class="line">  window.__SPEEDY__ = data;</span><br><span class="line"></span><br><span class="line">  const root = document.getElementById(&apos;root&apos;);</span><br><span class="line">  if (!root) &#123;</span><br><span class="line">    throw new Error(&apos;ğŸ”¥ Hmm, cannot find `#root` to mount the component.&apos;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (!data.__SSR__) &#123;</span><br><span class="line">    ReactDOM.render(&lt;Browser /&gt;, root);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    const &#123; assetsMeta, matchedPage &#125; = data.__CONTEXT__;</span><br><span class="line"></span><br><span class="line">    const &#123; assets, module &#125; = assetsMeta[matchedPage.name];</span><br><span class="line">    const routeModule = await loadRouteModules(assets, module, matchedPage.name);</span><br><span class="line">    data.__CONTEXT__.routeModules[matchedPage.name] = routeModule;</span><br><span class="line"></span><br><span class="line">    ReactDOM.hydrate(&lt;Browser /&gt;, root);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  window.__SPEEDY_APP_LOADED__ = true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">init();</span><br></pre></td></tr></table></figure>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> clientVirtualEntryCode <span class="keyword">from</span> <span class="string">'./virtual-entry/client?raw'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> clientPlugin = (&#123; appContext &#125;: &#123; appContext: AppContext &#125;): <span class="function"><span class="params">SpeedyPlugin</span> =&gt;</span> &#123;</span><br><span class="line">  compiler.hooks.load.tapPromise(CLIENT_PLUGIN_NAME, <span class="keyword">async</span> (args) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">new</span> <span class="built_in">RegExp</span>(VIRTUAL_ENTRY_SUFFIX).test(args.path)) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; query &#125; = resolvePathAndQuery(args.path);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> pageName = query[QUERY_PAGE_NAME];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!pageName) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pageName === VIRTUAL_ROOT_NAME) &#123;</span><br><span class="line">      <span class="comment">// æŠŠæ¨¡æ¿ä»£ç ä½œä¸ºå­—ç¬¦ä¸²è¿”å›ç»™ speedy è¿›è¡Œç¼–è¯‘ï¼Œå®ç°äº†å¯¹ç”¨æˆ·ä»£ç çš„å°è£…</span></span><br><span class="line">      <span class="keyword">const</span> entryHelper = <span class="keyword">new</span> EntryHelper(clientVirtualEntryCode);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        loader: <span class="string">'tsx'</span>,</span><br><span class="line">        resolveDir: root,</span><br><span class="line">        contents: entryHelper.toString(),</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> page = appContext.getPageByName(pageName)!;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> prefetchPath = page.prefetch;</span><br><span class="line">    <span class="keyword">const</span> relativePrefetchPath = prefetchPath &amp;&amp; path.relative(root, prefetchPath);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> entryPath = page.entry;</span><br><span class="line">    <span class="keyword">const</span> relativeEntryPath = path.relative(root, entryPath);</span><br><span class="line">    <span class="keyword">const</span> entryHelper = <span class="keyword">new</span> EntryHelper(<span class="string">`export &#123; default &#125; from './<span class="subst">$&#123;relativeEntryPath&#125;</span>'`</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (prefetchPath &amp;&amp; fs.existsSync(prefetchPath)) &#123;</span><br><span class="line">      <span class="keyword">const</span> entryPoints: Record&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt; = &#123;</span><br><span class="line">        prefetch: prefetchPath,</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="keyword">const</span> buildResult = esbuild.buildSync(&#123;</span><br><span class="line">        absWorkingDir: root,</span><br><span class="line">        entryPoints,</span><br><span class="line">        outdir: root,</span><br><span class="line">        metafile: <span class="literal">true</span>,</span><br><span class="line">        write: <span class="literal">false</span>,</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="keyword">const</span> prefetchExportedNames = buildResult.metafile?.outputs?.[<span class="string">'prefetch.js'</span>]?.exports;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> isSSG = prefetchExportedNames?.includes(<span class="string">'getStaticProps'</span>);</span><br><span class="line">      <span class="keyword">const</span> isSSR = prefetchExportedNames?.includes(<span class="string">'default'</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (isSSG) &#123;</span><br><span class="line">        prefetchTypeMap[pageName] = PREFETCH_TYPE.SSG;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isSSR) &#123;</span><br><span class="line">        prefetchTypeMap[pageName] = PREFETCH_TYPE.SSR;</span><br><span class="line"></span><br><span class="line">        entryHelper.addReExport(&#123;</span><br><span class="line">          exportName: <span class="string">'default as getServerSideProps'</span>,</span><br><span class="line">          filepath: <span class="string">`./<span class="subst">$&#123;relativePrefetchPath&#125;</span>`</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      loader: <span class="string">'tsx'</span>,</span><br><span class="line">      resolveDir: root,</span><br><span class="line">      contents: entryHelper.toString(),</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢æ˜¯ <code>basic</code> ä¸ºä¾‹å­ç”Ÿæˆçš„ <code>__ROOT__.js</code> å’Œ <code>client/ssr.js</code> çš„ç®€åŒ–ç‰ˆæœ¬:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// __ROOT__.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">init</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ°´åˆé€»è¾‘</span></span><br><span class="line">init()</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// React ç»„ä»¶</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">App</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> App</span><br><span class="line"><span class="comment">// æ•°æ®é¢„å–å‡½æ•°</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">getServerSideProps</span>(<span class="params"></span>)</span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>å¦å¤– <code>clientPlugin</code> åœ¨åå¤„ç† HTML æ–‡ä»¶çš„æ—¶å€™ï¼Œä¼šåŠ å…¥ä¸€äº›å…ƒä¿¡æ¯ï¼ˆmanifestï¼‰ï¼Œåç»­å¯ä¾›ä½¿ç”¨ï¼š</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line">compiler.hooks.processAssets.tapPromise(</span><br><span class="line">  &#123;</span><br><span class="line">    name: CLIENT_PLUGIN_NAME,</span><br><span class="line">    stage: compiler.STAGE.PROCESS_ASSETS_MODIFY_GENERATED_HTML,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="keyword">async</span> (bundles, manifest) =&gt; &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> [chunkName, chunk] of compiler.outputChunk.entries()) &#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">      <span class="comment">// Append root.js to all html outputs</span></span><br><span class="line">      <span class="keyword">if</span> (chunkName.endsWith(<span class="string">'.html'</span>)) &#123;</span><br><span class="line">        <span class="comment">// add manifest to all pages</span></span><br><span class="line">        chunk.contents = chunk.contents.toString().replace(</span><br><span class="line">          <span class="string">'&lt;/body&gt;'</span>,</span><br><span class="line">          <span class="string">`</span></span><br><span class="line"><span class="string">          &lt;script id="<span class="subst">$&#123;__SPEEDY_DATA_ID__&#125;</span>" type="application/json"&gt;</span></span><br><span class="line"><span class="string">          <span class="subst">$&#123;serializeState&lt;SpeedyData&gt;(&#123;</span></span></span><br><span class="line"><span class="string"><span class="subst">            __CONTEXT__: &#123;</span></span></span><br><span class="line"><span class="string"><span class="subst">              basename: ssrOptions.baseUrl,</span></span></span><br><span class="line"><span class="string"><span class="subst">              matchedPage,</span></span></span><br><span class="line"><span class="string"><span class="subst">              pages: ssrOptions.pages,</span></span></span><br><span class="line"><span class="string"><span class="subst">              isModule,</span></span></span><br><span class="line"><span class="string"><span class="subst">              assetsMeta,</span></span></span><br><span class="line"><span class="string"><span class="subst">              routeData: &#123;&#125;</span>,</span></span><br><span class="line"><span class="string">              routeModules: &#123;&#125;,</span></span><br><span class="line"><span class="string">              getServerDataMeta: &#123;&#125;,</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            __SSR__: false,</span></span><br><span class="line"><span class="string">          &#125;)&#125;</span></span><br><span class="line"><span class="string">          &lt;/script&gt;</span></span><br><span class="line"><span class="string">          &lt;/body&gt;</span></span><br><span class="line"><span class="string">          `</span>.trim()</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>å†æ¥çœ‹ <code>serverPlugin</code> çš„æ ¸å¿ƒä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// packages/universal/src/bundler/react/plugins/virtual-entry/server.tsx</span><br><span class="line">import React from &apos;react&apos;;</span><br><span class="line">import &#123; Server &#125; from &apos;@speedy-js/universal/components&apos;;</span><br><span class="line">import type &#123; ServerSideRenderContext &#125; from &apos;@speedy-js/universal/interface&apos;;</span><br><span class="line">// @ts-ignore, __ENTRY_PATH__ è¦è¢«æ›¿æ¢ä¸ºå®é™…çš„è·¯å¾„æ‰èƒ½å®ç°å°è£…</span><br><span class="line">import Entry from &apos;__ENTRY_PATH__&apos;;</span><br><span class="line"></span><br><span class="line">export const Component: React.FC&lt;ServerSideRenderContext&gt; = (props) =&gt; &#123;</span><br><span class="line">  return (</span><br><span class="line">    &lt;Server &#123;...props&#125;&gt;</span><br><span class="line">      &lt;Entry /&gt;</span><br><span class="line">    &lt;/Server&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> serverVirtualEntryCode <span class="keyword">from</span> <span class="string">'./virtual-entry/server?raw'</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> serverPlugin = (&#123; appContext, root &#125;: ServerPluginOptions): <span class="function"><span class="params">SpeedyPlugin</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    name: SERVER_PLUGIN_NAME,</span><br><span class="line">    apply(compiler) &#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">      compiler.hooks.load.tapPromise(SERVER_PLUGIN_NAME, <span class="keyword">async</span> (args) =&gt; &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">new</span> <span class="built_in">RegExp</span>(VIRTUAL_ENTRY_SUFFIX).test(args.path)) &#123;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> &#123; query &#125; = resolvePathAndQuery(args.path);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> pageName = query[QUERY_PAGE_NAME];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!pageName) &#123;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> page = appContext.getPageByName(pageName)!;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> entryPath = page.entry;</span><br><span class="line">        <span class="keyword">const</span> prefetchPath = page.prefetch;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> entryPoints: Record&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt; = &#123;</span><br><span class="line">          server: entryPath,</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (prefetchPath) &#123;</span><br><span class="line">          entryPoints.prefetch = prefetchPath;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> buildResult = esbuild.buildSync(&#123;</span><br><span class="line">          absWorkingDir: root,</span><br><span class="line">          entryPoints,</span><br><span class="line">          outdir: root,</span><br><span class="line">          metafile: <span class="literal">true</span>,</span><br><span class="line">          write: <span class="literal">false</span>,</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> entryExportedNames = buildResult.metafile?.outputs[<span class="string">'server.js'</span>].exports;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> relativeEntryPath = path.relative(root, entryPath);</span><br><span class="line">        <span class="keyword">if</span> (!entryExportedNames?.includes(<span class="string">'default'</span>)) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`The component should be exported by default, file: <span class="subst">$&#123;relativeEntryPath&#125;</span>`</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> prefetchExportedNames = buildResult.metafile?.outputs?.[<span class="string">'prefetch.js'</span>]?.exports;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> hasPrefetch = !!prefetchExportedNames;</span><br><span class="line">        <span class="keyword">const</span> isSSG = prefetchExportedNames?.includes(<span class="string">'getStaticProps'</span>);</span><br><span class="line">        <span class="keyword">const</span> isSSR = prefetchExportedNames?.includes(<span class="string">'default'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> relativePrefetchPath = prefetchPath &amp;&amp; path.relative(root, prefetchPath);</span><br><span class="line">        <span class="keyword">if</span> (hasPrefetch) &#123;</span><br><span class="line">          <span class="keyword">if</span> (isSSG &amp;&amp; isSSR) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">              <span class="string">`Cannot export both 'getStaticProps' and 'default' at the same time in prefetch entry, please remove one of them, file: <span class="subst">$&#123;relativePrefetchPath&#125;</span>`</span></span><br><span class="line">            );</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (!isSSG &amp;&amp; !isSSR &amp;&amp; prefetchExportedNames) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">              <span class="string">`Should export one of 'getStaticProps' or 'default' in prefetch entry, file: <span class="subst">$&#123;relativePrefetchPath&#125;</span>`</span></span><br><span class="line">            );</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> entryHelper = <span class="keyword">new</span> EntryHelper(serverVirtualEntryCode);</span><br><span class="line"></span><br><span class="line">        entryHelper.replace(__ENTRY_PATH__, <span class="string">`./<span class="subst">$&#123;relativeEntryPath&#125;</span>`</span>);</span><br><span class="line">        <span class="keyword">if</span> (hasPrefetch) &#123;</span><br><span class="line">          entryHelper.addReExport(&#123;</span><br><span class="line">            exportName: isSSR ? <span class="string">'default as getServerSideProps'</span> : <span class="string">'getStaticProps'</span>,</span><br><span class="line">            filepath: <span class="string">`./<span class="subst">$&#123;relativePrefetchPath&#125;</span>`</span>,</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">          loader: <span class="string">'tsx'</span>,</span><br><span class="line">          resolveDir: root,</span><br><span class="line">          contents: entryHelper.toString(),</span><br><span class="line">        &#125;;</span><br><span class="line">      &#125;)</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢æ˜¯ <code>basic</code> ä¸ºä¾‹å­ç”Ÿæˆçš„ <code>server/ssr.js</code> çš„ç®€åŒ–ç‰ˆæœ¬:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// server/ssr.js</span></span><br><span class="line"><span class="comment">// React ç»„ä»¶</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">Component</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"><span class="comment">// æ•°æ®é¢„å–å‡½æ•°</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">getServerSideProps</span>(<span class="params"></span>)</span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="server-å®ç°"><a class="markdownIt-Anchor" href="#server-å®ç°"></a> Server å®ç°</h3>
<p><code>BaseServer</code> ä¸­ä¹Ÿæ˜¯åŒ…å«äº†ä¸€äº›é€šç”¨é€»è¾‘ï¼Œå¼€å‘æ¨¡å¼å’Œç”Ÿäº§æ¨¡å¼åˆ†åˆ«å®ç°å­ç±»ã€‚é€šç”¨é€»è¾‘æœ‰ï¼š</p>
<ul>
<li>
<p>åˆå§‹åŒ–ä¸€äº› Polyfill ï¼Œè¿™äº› Polyfill ç”¨äº Node.js ä¸­è¿è¡Œä¸€äº›æµè§ˆå™¨å¸¸ç”¨çš„ APIï¼Œä¾‹å¦‚ <code>atob</code>, <code>btoa</code>, fetch API çš„ <code>Headers</code>, <code>Request</code> å’Œ <code>Response</code> ç­‰ï¼Œå‚è€ƒäº† remix-node è¿›è¡Œå®ç°ã€‚</p>
</li>
<li>
<p>å®šä¹‰ä¸€ä¸ª Connect å®ä¾‹ <code>middlewares</code>ï¼Œè´Ÿè´£ä¸²è”æœåŠ¡å™¨çš„æ‰€æœ‰é€»è¾‘ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡å‘ <code>middlewares</code> ä¸­ <code>push</code> æ–°çš„å¤„ç†å‡½æ•°æ¥è‡ªå®šä¹‰æœåŠ¡å™¨çš„è¡Œä¸ºã€‚</p>
</li>
<li>
<p><code>prepare</code> å‡½æ•°ï¼Œä¾› Server å†…éƒ¨æ‰§è¡Œä¸€äº›å¼‚æ­¥å‡½æ•°ï¼Œç¡®ä¿å¼‚æ­¥å‡½æ•°æ‰§è¡Œå®Œä¹‹åå†è°ƒç”¨ Server çš„å…·ä½“æ–¹æ³•ã€‚</p>
</li>
<li>
<p><code>handleStatic</code> å¤„ç†é™æ€èµ„æºçš„é€»è¾‘ã€‚</p>
</li>
<li>
<p><code>handleServerSideRequest</code> å¤„ç†æœåŠ¡ç«¯è¯·æ±‚ã€‚åŒ…å« SSR è¯·æ±‚æ—¶ï¼ŒæœåŠ¡ç«¯çš„é€»è¾‘ï¼Œä¼šæ‰§è¡Œ server äº§ç‰©ä¸­çš„æ•°æ®é¢„å–å‡½æ•°å¹¶å®Œæˆè„±æ°´æµç¨‹ã€‚</p>
  <figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">abstract</span> <span class="keyword">class</span> BaseServer &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  handleServerSideRequest = <span class="keyword">async</span> (req: IncomingMessage, res: ServerResponse) =&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; framework, pages, baseUrl &#125; = <span class="keyword">this</span>.ssrOptions;</span><br><span class="line">      <span class="keyword">const</span> &#123; dev, root &#125; = <span class="keyword">this</span>.options;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!req.url) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> url = <span class="keyword">new</span> URL(req.url, <span class="string">`http://<span class="subst">$&#123;req.headers.host&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> matchedPage = matchPage(&#123;</span><br><span class="line">        pages,</span><br><span class="line">        pathname: url.pathname,</span><br><span class="line">        baseUrl,</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> &#123; prefetchTypeMap &#125; = <span class="keyword">this</span>.manifest;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (matchedPage?.name) &#123;</span><br><span class="line">        <span class="comment">// production, serve page as static files</span></span><br><span class="line">        <span class="keyword">if</span> (prefetchTypeMap[matchedPage.name] === PREFETCH_TYPE.SSG &amp;&amp; !dev) &#123;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> template = fs.readFileSync(getHtmlPath(<span class="keyword">this</span>.dist, matchedPage.name), <span class="string">'utf-8'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (url.searchParams.has(<span class="string">'csr'</span>)) &#123;</span><br><span class="line">          <span class="keyword">return</span> res.end(template);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// should not cache html files in browser</span></span><br><span class="line">        <span class="comment">// https://nextjs.org/docs/going-to-production#caching</span></span><br><span class="line">        res.setHeader(<span class="string">'Cache-Control'</span>, <span class="string">'no-cache, no-store, max-age=0, must-revalidate'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (framework === <span class="string">'react'</span>) &#123;</span><br><span class="line">          <span class="comment">// Renderer å†…éƒ¨ä¼šæ ¹æ®å½“å‰è¯·æ±‚é¡µé¢æ˜¯ SSR è¿˜æ˜¯ SSG å»è¿›è¡Œä¸åŒçš„æ¸²æŸ“é€»è¾‘ï¼›å¯ä»¥ç›´æ¥æ ¹æ®æ„å»ºäº§ç‰©çš„ export åç§°æ¥åˆ¤æ–­</span></span><br><span class="line">          <span class="keyword">const</span> renderer = <span class="keyword">new</span> Renderer(&#123;</span><br><span class="line">            baseUrl,</span><br><span class="line">            dist: <span class="keyword">this</span>.dist,</span><br><span class="line">            matchedPage,</span><br><span class="line">            name: matchedPage.name,</span><br><span class="line">            template,</span><br><span class="line">            pages,</span><br><span class="line">            root,</span><br><span class="line">            dev,</span><br><span class="line">            pageMeta: <span class="keyword">this</span>.manifest.entryMeta[matchedPage.name],</span><br><span class="line">            assetsMeta: <span class="keyword">this</span>.manifest.assetsMeta ?? &#123;&#125;,</span><br><span class="line">            isModule: <span class="keyword">this</span>.manifest.format === <span class="string">'esm'</span>,</span><br><span class="line">          &#125;);</span><br><span class="line">          <span class="comment">// å€Ÿé‰´äº† Remix çš„æ€æƒ³ï¼Œå°†æ‰€æœ‰è¯·æ±‚è½¬åŒ–ä¸º fetch API req/res æ¥è¿›è¡Œå¤„ç†ï¼Œrenderer åªéœ€è€ƒè™‘ fetch API å³å¯</span></span><br><span class="line">          <span class="keyword">const</span> response = <span class="keyword">await</span> withFetchAPI(req, res, <span class="keyword">async</span> (request) =&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> renderer.render(request);</span><br><span class="line">          &#125;);</span><br><span class="line">          <span class="keyword">return</span> response;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`universal server for framework <span class="subst">$&#123;framework&#125;</span> has not been implemented`</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><code>DevServer</code> éœ€è¦å¢åŠ  <code>handleStatic</code> å‡½æ•°çš„é€»è¾‘ï¼Œç”±äº Speedy å†…éƒ¨å·²ç»å®ç°äº†å¯¹é™æ€èµ„æºçš„ serverï¼Œç›´æ¥å¯¹å…¶è¿›è¡Œä»£ç†å³å¯ï¼š</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> DevServer &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  handleRequest: SimpleHandleFunction = <span class="keyword">async</span> (req: IncomingMessage, res: ServerResponse) =&gt; &#123;</span><br><span class="line">      <span class="keyword">this</span>.setHttpProxyHandler(req);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> resp = <span class="keyword">await</span> <span class="keyword">this</span>.handleServerSideRequest(req, res);</span><br><span class="line">        <span class="keyword">if</span> (resp) &#123;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(e);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (path.parse(req.url ?? <span class="string">'/'</span>).ext) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.handleStatic(req, res);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> res.end(renderNotFound());</span><br><span class="line">    &#125;;</span><br><span class="line">  handleStatic: SimpleHandleFunction = <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> httpProxy = <span class="keyword">this</span>.getHttpProxy();</span><br><span class="line">    <span class="comment">// https://nextjs.org/docs/going-to-production#caching</span></span><br><span class="line">    res.setHeader(<span class="string">'Cache-Control'</span>, <span class="string">'no-cache, no-store, max-age=0, must-revalidate'</span>);</span><br><span class="line">    httpProxy.web(req, res);</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯¹äº <code>ProdServer</code>ï¼Œåˆ™æœ‰ä¸åŒçš„ <code>handleStatic</code> é€»è¾‘ï¼Œä»äº§ç‰©ä¸­è¿›è¡Œ serve:</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line">handleStatic: Connect.SimpleHandleFunction = <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; url: reqUrl = <span class="string">''</span> &#125; = req;</span><br><span class="line">  <span class="keyword">const</span> publicPath = getPublicPath(<span class="keyword">this</span>.manifest.publicPath);</span><br><span class="line">  <span class="keyword">const</span> &#123; baseUrl &#125; = <span class="keyword">this</span>.ssrOptions;</span><br><span class="line">  <span class="keyword">const</span> name = reqUrl</span><br><span class="line">    .split(<span class="string">'?'</span>)[<span class="number">0</span>]</span><br><span class="line">    .replace(<span class="regexp">/.html?$/</span>, <span class="string">''</span>)</span><br><span class="line">    .replace(baseUrl, <span class="string">''</span>)</span><br><span class="line">    .slice(baseUrl === <span class="string">'/'</span> ? <span class="number">0</span> : <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> filename = getFilenameFromUrl(<span class="string">`/<span class="subst">$&#123;name ?? <span class="string">''</span>&#125;</span>`</span>, [</span><br><span class="line">    &#123;</span><br><span class="line">      publicPath,</span><br><span class="line">      outputPath: <span class="keyword">this</span>.dist,</span><br><span class="line">    &#125;,</span><br><span class="line">  ]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!filename || !fs.existsSync(filename) || fs.lstatSync(filename).isDirectory()) &#123;</span><br><span class="line">    res.statusCode = <span class="number">404</span>;</span><br><span class="line">    res.end(<span class="string">'Page Not Found'</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> reqPath = <span class="built_in">decodeURI</span>(url.parse(reqUrl).pathname || <span class="string">''</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> mimeType = lookup(reqPath) || lookup(filename);</span><br><span class="line">  <span class="keyword">if</span> (mimeType) &#123;</span><br><span class="line">    res.setHeader(<span class="string">'Content-Type'</span>, mimeType);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  res.statusCode = <span class="number">200</span>;</span><br><span class="line">  <span class="comment">// https://developers.google.com/web/fundamentals/performance/webpack/use-long-term-caching</span></span><br><span class="line">  <span class="comment">// https://nextjs.org/docs/going-to-production#caching</span></span><br><span class="line">  res.setHeader(<span class="string">'Cache-Control'</span>, <span class="string">'public, max-age=31536000, immutable'</span>);</span><br><span class="line">  fs.createReadStream(filename).pipe(res);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ç„¶åæˆ‘ä»¬å®ç°äº† <code>universal</code> è¿™ä¸ªè„šæœ¬ï¼Œæ·»åŠ  <code>universal dev</code> å’Œ <code>universal build</code> åˆ†åˆ«æ¥è¿›è¡Œå¼€å‘å’Œæ„å»ºï¼Œå¯ä»¥ç”¨ <code>universal start</code> æ¥å¯åŠ¨ <code>ProdServer</code>ã€‚</p>
<h3 id="adapter-å®ç°"><a class="markdownIt-Anchor" href="#adapter-å®ç°"></a> Adapter å®ç°</h3>
<p>ä¸ºäº†è®©æˆ‘ä»¬çš„ä»£ç ä¸ä»…èƒ½åœ¨ Node.js ç¯å¢ƒä¸‹é¢é€šè¿‡ <code>universal</code> CLI æ¥éƒ¨ç½²ï¼Œè¿˜æƒ³åœ¨ Vercel å’Œ CloudFlare ä»¥åŠå…¬å¸å†…çš„å…¶ä»– Serverless æˆ–è€… Edge ä¸Šéƒ¨ç½²ï¼Œæˆ‘ä»¬å‚è€ƒäº† <a href="https://remix.run/docs/en/main/other-api/adapter" target="_blank" rel="noopener">Remix Adapter</a> çš„æ€æƒ³æ¥æ”¯æŒä¸åŒçš„é€‚é…å™¨ï¼Œå®ç°ä¸åŒç¯å¢ƒéƒ¨ç½²ã€‚</p>
<p>ä¾‹å¦‚ Vercel Adapter å®ç°å¦‚ä¸‹:</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="comment">// packages/universal/src/adapters/vercel/index.ts</span></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; IncomingMessage, ServerResponse &#125; <span class="keyword">from</span> <span class="string">'http'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ProdServer &#125; <span class="keyword">from</span> <span class="string">'../../server/prod-server'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> VercelAdapterOptions &#123;</span><br><span class="line">  root?: <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createVercelHandler</span>(<span class="params">&#123; root = process.cwd() &#125;: VercelAdapterOptions = &#123;&#125;</span>): (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  req: IncomingMessage,</span></span></span><br><span class="line"><span class="function"><span class="params">  res: ServerResponse</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) =&gt; <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> server = <span class="keyword">new</span> ProdServer(&#123; root &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">async</span> (req: IncomingMessage, res: ServerResponse) =&gt; &#123;</span><br><span class="line">    <span class="keyword">await</span> server.prepare();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> handler = server.getRequestHandler();</span><br><span class="line">    <span class="keyword">return</span> handler(req, res);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º <code>server.vercel.js</code>:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// server.vercel.js</span></span><br><span class="line"><span class="comment">// @ts-check</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; createVercelHandler &#125; = <span class="built_in">require</span>(<span class="string">'@speedy-js/universal/adapters/vercel'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = createVercelHandler();</span><br></pre></td></tr></table></figure>
<p><code>vercel.json</code>:</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"version"</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="attr">"public"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">"github"</span>: &#123;</span><br><span class="line">    <span class="attr">"enabled"</span>: <span class="literal">false</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"builds"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"src"</span>: <span class="string">"./server.vercel.js"</span>,</span><br><span class="line">      <span class="attr">"use"</span>: <span class="string">"@vercel/node"</span>,</span><br><span class="line">      <span class="attr">"config"</span>: &#123;</span><br><span class="line">        <span class="attr">"//"</span>: <span class="string">"https://github.com/vercel/vercel/issues/1788#issuecomment-485629244"</span>,</span><br><span class="line">        <span class="attr">"includeFiles"</span>: [<span class="string">"./.universal/**"</span>],</span><br><span class="line">        <span class="attr">"bundle"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">"maxLambdaSize"</span>: <span class="string">"50mb"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"routes"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"src"</span>: <span class="string">"/(.*)"</span>,</span><br><span class="line">      <span class="attr">"dest"</span>: <span class="string">"/server.vercel.js"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œ <code>vercel --prod</code> å³å¯éƒ¨ç½²åˆ° Vercelã€‚</p>
<hr>
<p>CF Worker çš„ Adapter å®ç°ä¹Ÿå¾ˆç®€å•:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/// &lt;reference lib="dom.iterable"/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; getAssetFromKV, MethodNotAllowedError, NotFoundError &#125; <span class="keyword">from</span> <span class="string">'@cloudflare/kv-asset-handler'</span>;</span><br><span class="line"><span class="keyword">import</span> type &#123; CloudflareBuildManifest &#125; <span class="keyword">from</span> <span class="string">'./interface'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; PREFETCH_TYPE &#125; <span class="keyword">from</span> <span class="string">'../../interface'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; renderToHTML &#125; <span class="keyword">from</span> <span class="string">'../../helpers/render'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; getQuery &#125; <span class="keyword">from</span> <span class="string">'../../helpers/getQuery'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; matchPage, PageMatch &#125; <span class="keyword">from</span> <span class="string">'../../helpers/matchPage'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; FetchEvent &#125; <span class="keyword">from</span> <span class="string">'../../../client'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> * <span class="keyword">from</span> <span class="string">'./interface'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> interface CloudflareWorkerAdapterOptions &#123;</span><br><span class="line">  dev?: boolean;</span><br><span class="line">  root?: string;</span><br><span class="line">  manifest: CloudflareBuildManifest;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> interface CloudflareWorkerServerOptions extends CloudflareWorkerAdapterOptions &#123;</span><br><span class="line">  event: FetchEvent;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CloudflareWorkerServer</span> </span>&#123;</span><br><span class="line">  options: CloudflareWorkerServerOptions;</span><br><span class="line"></span><br><span class="line">  pathname: string;</span><br><span class="line"></span><br><span class="line">  origin: string;</span><br><span class="line"></span><br><span class="line">  url: URL;</span><br><span class="line"></span><br><span class="line">  matchedPage: PageMatch | <span class="literal">undefined</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(options: CloudflareWorkerServerOptions) &#123;</span><br><span class="line">    <span class="keyword">this</span>.options = options;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; event &#125; = <span class="keyword">this</span>.options;</span><br><span class="line">    <span class="keyword">this</span>.url = <span class="keyword">new</span> URL(event.request.url);</span><br><span class="line">    <span class="keyword">this</span>.pathname = <span class="keyword">this</span>.url.pathname;</span><br><span class="line">    <span class="keyword">this</span>.origin = <span class="keyword">this</span>.url.origin;</span><br><span class="line">    <span class="keyword">this</span>.matchedPage = <span class="keyword">this</span>.matchPageName(<span class="keyword">this</span>.pathname)!;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> handleAssets(): <span class="built_in">Promise</span>&lt;Response&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; pathname &#125; = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">await</span> getAssetFromKV(<span class="keyword">this</span>.options.event, &#123;</span><br><span class="line">        mapRequestToAsset: <span class="function">(<span class="params">request</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="comment">// è¿™é‡Œä½¿ç”¨äº† manifest æ–‡ä»¶</span></span><br><span class="line">          <span class="keyword">const</span> &#123; baseUrl &#125; = <span class="keyword">this</span>.options.manifest.ssrOptions;</span><br><span class="line">          <span class="keyword">if</span> (pathname.startsWith(baseUrl)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.matchedPage?.name) &#123;</span><br><span class="line">              <span class="keyword">return</span> <span class="keyword">new</span> Request(<span class="keyword">new</span> URL(<span class="string">`<span class="subst">$&#123;<span class="keyword">this</span>.matchedPage.name&#125;</span>.html`</span>, <span class="keyword">this</span>.origin).href);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Request(<span class="keyword">new</span> URL(pathname.replace(baseUrl, <span class="string">''</span>), <span class="keyword">this</span>.origin).href);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> request;</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="keyword">if</span> (e <span class="keyword">instanceof</span> NotFoundError) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Response(<span class="string">'NotFoundError'</span>, &#123; <span class="attr">status</span>: <span class="number">404</span> &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (e <span class="keyword">instanceof</span> MethodNotAllowedError) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Response(<span class="string">'MethodNotAllowedError'</span>, &#123; <span class="attr">status</span>: <span class="number">500</span> &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Response(<span class="string">'An unexpected error occurred'</span>, &#123; <span class="attr">status</span>: <span class="number">500</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> getAsset(url: string): <span class="built_in">Promise</span>&lt;string&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> getAssetFromKV(&#123;</span><br><span class="line">      request: <span class="keyword">new</span> Request(<span class="keyword">new</span> URL(url, <span class="keyword">this</span>.origin).href),</span><br><span class="line">      waitUntil: <span class="function"><span class="params">()</span> =&gt;</span> &#123;&#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> res.text();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> handleSSRRequest(): <span class="built_in">Promise</span>&lt;Response&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">      manifest,</span><br><span class="line">      event: &#123; request &#125;,</span><br><span class="line">    &#125; = <span class="keyword">this</span>.options;</span><br><span class="line">    <span class="keyword">const</span> &#123; pathname, search &#125; = <span class="keyword">this</span>.url;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.matchedPage) <span class="keyword">return</span> <span class="keyword">new</span> Response(<span class="string">'No matched SSR page'</span>, &#123; <span class="attr">status</span>: <span class="number">404</span> &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> templateHtmlPath = <span class="string">`/<span class="subst">$&#123;<span class="keyword">this</span>.matchedPage.name&#125;</span>.html`</span>;</span><br><span class="line">    <span class="keyword">const</span> template = <span class="keyword">await</span> <span class="keyword">this</span>.getAsset(templateHtmlPath);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; Component, getServerSideProps &#125; = manifest.exportsMap[<span class="keyword">this</span>.matchedPage.name].server;</span><br><span class="line">    <span class="keyword">const</span> response = <span class="keyword">new</span> Response();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> html = <span class="keyword">await</span> renderToHTML(&#123;</span><br><span class="line">        Component,</span><br><span class="line">        getServerSideProps,</span><br><span class="line">        assetsMeta: manifest.assetsMeta,</span><br><span class="line">        basename: manifest.ssrOptions.baseUrl,</span><br><span class="line">        template,</span><br><span class="line">        pages: manifest.ssrOptions.pages,</span><br><span class="line">        matchedPage: <span class="keyword">this</span>.matchedPage,</span><br><span class="line">        context: &#123;</span><br><span class="line">          request,</span><br><span class="line">          response,</span><br><span class="line">          pathname,</span><br><span class="line">          query: getQuery(search),</span><br><span class="line">        &#125;,</span><br><span class="line">        isModule: manifest.format === <span class="string">'esm'</span>,</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Response(html, &#123;</span><br><span class="line">        ...response,</span><br><span class="line">        headers: &#123; ...Object.fromEntries(response.headers.entries()), <span class="string">'Content-Type'</span>: <span class="string">'text/html'</span> &#125;,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err: any) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`Error when calling render function of server file: <span class="subst">$&#123;templateHtmlPath&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  matchPageName(pathname: string) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; ssrOptions &#125; = <span class="keyword">this</span>.options.manifest;</span><br><span class="line">    <span class="keyword">const</span> match = matchPage(&#123; <span class="attr">pages</span>: ssrOptions.pages, pathname, <span class="attr">baseUrl</span>: ssrOptions.baseUrl &#125;);</span><br><span class="line">    <span class="keyword">return</span> match;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> handleRequest() &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; request &#125; = <span class="keyword">this</span>.options.event;</span><br><span class="line">    <span class="keyword">const</span> &#123; ssrOptions, prefetchTypeMap, exportsMap &#125; = <span class="keyword">this</span>.options.manifest;</span><br><span class="line">    <span class="keyword">const</span> &#123; framework &#125; = ssrOptions;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; searchParams &#125; = <span class="keyword">this</span>.url;</span><br><span class="line">    <span class="keyword">if</span> (searchParams.get(<span class="string">'__data'</span>)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="keyword">this</span>.matchedPage) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Response(<span class="string">'No matched SSR page for data'</span>, &#123; <span class="attr">status</span>: <span class="number">404</span> &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> &#123; getServerSideProps &#125; = exportsMap[<span class="keyword">this</span>.matchedPage.name].server;</span><br><span class="line">      <span class="keyword">if</span> (!getServerSideProps) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Response(<span class="string">'No matched SSR export getServerSideProps for data'</span>, &#123; <span class="attr">status</span>: <span class="number">404</span> &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> response = <span class="keyword">new</span> Response();</span><br><span class="line">      <span class="keyword">const</span> data = <span class="keyword">await</span> getServerSideProps(&#123;</span><br><span class="line">        request,</span><br><span class="line">        response,</span><br><span class="line">        pathname: <span class="keyword">this</span>.pathname ?? <span class="string">'/'</span>,</span><br><span class="line">        query: searchParams,</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Response(<span class="built_in">JSON</span>.stringify(data), &#123;</span><br><span class="line">        ...response,</span><br><span class="line">        headers: &#123;</span><br><span class="line">          ...Object.fromEntries(response.headers.entries()),</span><br><span class="line">          <span class="string">'Content-Type'</span>: <span class="string">'application/json'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.matchedPage?.name) &#123;</span><br><span class="line">      <span class="keyword">if</span> (prefetchTypeMap[<span class="keyword">this</span>.matchedPage.name] === PREFETCH_TYPE.SSR) &#123;</span><br><span class="line">        <span class="keyword">if</span> (framework === <span class="string">'react'</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">this</span>.handleSSRRequest();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`universal server for framework <span class="subst">$&#123;framework&#125;</span> has not been implemented`</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å…¶ä»–æƒ…å†µçš„è¯æ˜¯é™æ€èµ„æºï¼Œä½¿ç”¨ CF Worker çš„ KV å­˜å‚¨å¤„ç†ï¼Œæ„å»ºäº§ç‰©éœ€è¦ä¸Šä¼ åˆ° KV å­˜å‚¨</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.handleAssets();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç»™çš„æ˜¯ fetchAPI Requestï¼Œæˆ‘ä»¬è¦è¿”å› fetchAPI Response</span></span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span> proxy the web socket connection when developing</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createCloudflareWorkerHandler</span>(<span class="params">options: CloudflareWorkerAdapterOptions</span>): (<span class="params">event: FetchEvent</span>) =&gt; <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> server = <span class="keyword">new</span> CloudflareWorkerServer(&#123;</span><br><span class="line">      ...options,</span><br><span class="line">      event,</span><br><span class="line">    &#125;);</span><br><span class="line">    event.respondWith(server.handleRequest());</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ç”¨åˆ°äº† manifest æ–‡ä»¶æ¥å®ç°å¯¼å…¥å¯¹åº”é¡µé¢çš„ä»£ç ï¼Œmanifest æ˜¯ç”± <code>clientPlugin</code> ç”Ÿæˆçš„:</p>
<p><img src="https://s2.loli.net/2023/05/21/WAzLY2lEGQxvdft.png" alt="manifest"></p>
<p>é…ç½® <code>wrangler.toml</code>:</p>
<figure class="highlight toml"><table><tr><td class="code"><pre><span class="line"><span class="attr">name</span> = <span class="string">"ssr-react-example"</span></span><br><span class="line"><span class="attr">type</span> = <span class="string">"javascript"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">zone_id</span> = <span class="string">""</span></span><br><span class="line"><span class="attr">account_id</span> = <span class="string">""</span></span><br><span class="line"><span class="attr">route</span> = <span class="string">""</span></span><br><span class="line"><span class="attr">workers_dev</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="section">[site]</span></span><br><span class="line"><span class="comment"># These two settings are necessary to save the assets to CF KV storage</span></span><br><span class="line"><span class="comment"># https://developers.cloudflare.com/workers/cli-wrangler/commands#kvkey</span></span><br><span class="line"><span class="comment"># https://developers.cloudflare.com/workers/cli-wrangler/configuration#site</span></span><br><span class="line"><span class="attr">bucket</span> = <span class="string">".universal"</span></span><br><span class="line"><span class="attr">entry-point</span> = <span class="string">"."</span></span><br><span class="line"></span><br><span class="line"><span class="section">[build]</span></span><br><span class="line"><span class="attr">command</span> = <span class="string">"pnpm build:cf-worker"</span></span><br><span class="line"><span class="attr">watch_dir</span> = <span class="string">"src"</span></span><br><span class="line"></span><br><span class="line"><span class="section">[build.upload]</span></span><br><span class="line"><span class="attr">format</span>=<span class="string">"service-worker"</span></span><br></pre></td></tr></table></figure>
<p>éƒ¨ç½²çš„è¯è¿è¡Œ <code>wrangler publish</code> å³å¯ã€‚</p>
<h2 id="æ€»ç»“ä¸æ€è€ƒ"><a class="markdownIt-Anchor" href="#æ€»ç»“ä¸æ€è€ƒ"></a> æ€»ç»“ä¸æ€è€ƒ</h2>
<p>æœ¬æ–‡ä»‹ç»çš„æ˜¯ Speedy çš„ SSR å®ç°ï¼Œåœ¨å®ç° Speedy SSR çš„è¿‡ç¨‹ä¸­å‚è€ƒäº† Viteã€Next.js å’Œ Remixã€‚å…¶å®ä¸šç•Œçš„ SSR å®ç°æ€»ä½“æ€è·¯éƒ½æ˜¯åŸºæœ¬ä¸Šä¸€è‡´çš„ï¼Œä¸»è¦çš„ç‚¹æœ‰ï¼š</p>
<ul>
<li>ä¸€ä»½ä»£ç ï¼Œä¸¤ä»½äº§ç‰©ï¼Œå®ç°å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å¤ç”¨</li>
<li>å¼€å‘ä½“éªŒï¼ŒAPI è®¾è®¡ç®€æ´ï¼Œå¯æ‹“å±•æ€§å¼ºï¼Œå¼€å‘é€Ÿåº¦å¿«</li>
<li>éƒ¨ç½²åˆ°ä¸åŒçš„ç¯å¢ƒçš„æ”¯æŒ</li>
<li>æ€§èƒ½æå‡ï¼Œæœ€ç»ˆçš„ç›®æ ‡æ˜¯æå‡é¡µé¢çš„é¦–å±æ€§èƒ½ï¼Œè¾¾åˆ°ç§’å¼€çš„ç›®çš„ã€‚</li>
</ul>
<p>Speedy æœ€ç»ˆä»¥å¤±è´¥è€Œå‘Šç»ˆï¼Œå»å¹´å·²ç»é€æ¸ä¸å†ç»´æŠ¤äº†ï¼Œä¸»è¦è¿˜æ˜¯ esbuild çš„å…³æ³¨ç‚¹å’Œå…¶ä»–æ„å»ºå·¥å…·ä¸ä¸€æ ·ï¼Œä¾‹å¦‚ HMRã€æ‹†åŒ…ç­‰å°±åšçš„å¾ˆä¸å¥½ï¼›Rspack æˆä¸ºäº†å›¢é˜Ÿæ–°æ¨çš„æ„å»ºå·¥å…·ï¼Œä¸¤è€…éƒ½å€Ÿé‰´äº† Webpack çš„æ’ä»¶ä½“ç³»ï¼Œæƒ³åšçš„ä¸œè¥¿ä¹Ÿå¾ˆç±»ä¼¼ï¼Œå°±æ˜¯æå‡å¤§å®¶çš„å¼€å‘æ•ˆç‡ï¼Œä¸è¿‡æˆ‘æ²¡æœ‰å‚ä¸è¿‡ Rspack çš„å¼€å‘ï¼Œå°±ä¸æ˜¯å¾ˆç†Ÿæ‚‰äº†ã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™"><a class="markdownIt-Anchor" href="#å‚è€ƒèµ„æ–™"></a> å‚è€ƒèµ„æ–™</h2>
<ol>
<li><a href="https://github.com/upupming/speedy-ssr-examples" target="_blank" rel="noopener">https://github.com/upupming/speedy-ssr-examples</a></li>
<li><a href="http://www.ayqy.net/blog/diference-between-ssr-and-jsp-php/" target="_blank" rel="noopener">SSRä¸å½“å¹´çš„JSPã€PHPæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</a></li>
<li><a href="https://vitejs.dev/guide/ssr.html" target="_blank" rel="noopener">https://vitejs.dev/guide/ssr.html</a></li>
<li><a href="https://github.com/vitejs/vite/tree/main/packages/playground" target="_blank" rel="noopener">https://github.com/vitejs/vite/tree/main/packages/playground</a></li>
<li><a href="https://github.com/frandiox/vite-ssr" target="_blank" rel="noopener">https://github.com/frandiox/vite-ssr</a></li>
<li><a href="https://vitedge.js.org/" target="_blank" rel="noopener">https://vitedge.js.org/</a></li>
<li><a href="https://vercel.com/guides/using-express-with-vercel" target="_blank" rel="noopener">https://vercel.com/guides/using-express-with-vercel</a></li>
<li><a href="https://blog.cloudflare.com/serverless-rendering-with-cloudflare-workers/" target="_blank" rel="noopener">https://blog.cloudflare.com/serverless-rendering-with-cloudflare-workers/</a></li>
<li><a href="https://next-code-elimination.vercel.app/" target="_blank" rel="noopener">https://next-code-elimination.vercel.app/</a></li>
</ol>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="mailto:undefined">upupming</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="https://upupming.site/2023/05/21/bundler-ssr/">https://upupming.site/2023/05/21/bundler-ssr/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="https://upupming.site">upupming çš„åšå®¢</a>ï¼</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/frontend/">frontend</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2024/02/25/ssr-introduction/"><i class="fa fa-chevron-left">  </i><span>æœåŠ¡ç«¯æ¸²æŸ“çš„åŸç†ä¸å®ç°</span></a></div><div class="next-post pull-right"><a href="/2022/03/25/typescript-getting-started/"><span>æˆ‘çœ¼ä¸­çš„ TypeScriptï¼ˆå…¥é—¨çº§åˆ«ä»‹ç»ï¼‰</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="vcomment"></div><script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = 'true' == true ? true : false;
var verify = 'false' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'wiHsGgANF4mLmK2Hiubzew03-gzGzoHsz',
  appKey:'Tk0WjoOhLD8ppTfyhdCbyeDT',
  placeholder:'Just go go',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10',
  lang: 'zh-cn'
})</script></div></div><footer class="footer-bg" style="background-image: url(/img/background.png)"><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2024 By upupming</div><div class="framework-info"><span>é©±åŠ¨ - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>ä¸»é¢˜ - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script src="/js/search/algolia.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css"><script src="/js/katex.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="algolia-search"><div class="search-dialog__title" id="algolia-search-title">Algolia</div><div id="algolia-input-panel"><div id="algolia-search-input"></div></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>